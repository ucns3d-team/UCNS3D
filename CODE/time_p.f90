MODULE ADVANCE
USE LIBRARY
USE TRANSFORM
USE FLUXES
USE SOURCE
USE INITIALISATION
USE BOUNDARY
USE RECON
USE LOCAL
USE FLOW_OPERATIONS
USE COMMUNICATIONS
USE implicit_time
USE implicit_FLUXES
USE DECLARATION
! USE FLUXES_V
USE IO
USE MOODR
IMPLICIT NONE

 CONTAINS
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!---------------------------------------------------------------------------------------------!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!SUBROUTINE CALLED TO CALCULATE CFL NUMBER DEPENDING ON THE SCHEME!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!EMPLOYED!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
SUBROUTINE CALCULATE_CFL(N)
!> @brief
!> subroutine for computing the global time step size in 3D
IMPLICIT NONE
INTEGER,INTENT(IN)::N
INTEGER::I,K,L,KMAXE,J,INGTMAX,INGTMIN,WHGU,WHGL
REAL::SUVI,SUV3,maxU,MINU
REAL::CCFL,VELN,AGRT
KMAXE=XMPIELRANK(N)
       
        CCFL=(CFL/3.0d0)
        
        DT=tolbig
	IF (ITESTCASE.LT.3)THEN
	!$OMP DO REDUCTION (MIN:DT)
        DO I=1,KMAXE
		VELN=MAX(ABS(LAMx),ABS(LAMy),ABS(LAMz))
		DT=MIN(DT,CCFL*((IELEM(N,I)%MINEDGE)/(ABS(VELN))))
	END DO
	!$OMP END DO
	END IF
	
	IF (ITESTCASE.EQ.3)THEN
	!$OMP DO REDUCTION (MIN:DT)
        DO I=1,KMAXE
		LEFTV(1:NOF_vARIABLES)=U_C(I)%VAL(1,1:NOF_vARIABLES)
		
		CALL CONS2PRIM(N)
		IF (multispecies.eq.1)THEN
		AGRT=SQRT((LEFTV(5)+MP_PINFL)*GAMMAl/LEFTV(1))
		ELSE
		AGRT=SQRT(LEFTV(5)*GAMMA/LEFTV(1))
		END IF
		
		VELN=MAX(ABS(LEFTV(2)),ABS(LEFTV(3)),ABS(LEFTV(4)))+AGRT
		DT=MIN(DT,CCFL*((IELEM(N,I)%MINEDGE)/(ABS(VELN))))
	END DO
	!$OMP END DO
	END IF
	
	
	
	IF (ITESTCASE.EQ.4)THEN
	!$OMP DO REDUCTION (MIN:DT)
        DO I=1,KMAXE
		LEFTV(1:NOF_vARIABLES)=U_C(I)%VAL(1,1:NOF_vARIABLES)
		CALL CONS2PRIM(N)
		RIGHTV(1:NOF_vARIABLES)=LEFTV(1:NOF_vARIABLES)
		CALL SUTHERLAND(N,LEFTV,RIGHTV)
		AGRT=SQRT(LEFTV(5)*GAMMA/LEFTV(1))
		VELN=MAX(ABS(LEFTV(2)),ABS(LEFTV(3)),ABS(LEFTV(4)))+AGRT
		
		IF (TURBULENCE.EQ.1)THEN
		IF (TURBULENCEMODEL.EQ.1)THEN
		TURBMV(1)=U_CT(I)%VAL(1,1);  TURBMV(2)=U_CT(I)%VAL(1,1);
		eddyfl(2)=turbmv(1); eddyfr(2)=turbmv(2)
		CALL EDDYVISCO(N,VISCL,LAML,TURBMV,ETVM,EDDYFL,EDDYFR)
		LAML(1)=LAML(1)+LAML(3)
		VISCL(1)=VISCL(1)+VISCL(3)
		END IF
		END IF
		
		
		
		
		
         DT=MIN(DT,CCFL*(1.0D0/((ABS(VELN)/((IELEM(N,I)%MINEDGE))) + (0.5D0*(LAML(1)+VISCL(1))/((IELEM(N,I)%MINEDGE))**2))))
                             
	END DO
	!$OMP END DO
	END IF
	
	
        RETURN
        
END SUBROUTINE CALCULATE_CFL

SUBROUTINE CALCULATE_CFLL(N)
!> @brief
!> subroutine for computing the time step size for each cell in 3D
IMPLICIT NONE
INTEGER,INTENT(IN)::N
INTEGER::I,K,L,KMAXE,J,INGTMAX,INGTMIN,WHGU,WHGL
REAL::SUVI,SUV3,maxU,MINU
REAL::CCFL,VELN,AGRT
KMAXE=XMPIELRANK(N)
       
        CCFL=(CFL/3.0d0)
        
        
	IF (ITESTCASE.LT.3)THEN
	!$OMP DO SCHEDULE (STATIC)
        DO I=1,KMAXE
		VELN=MAX(ABS(LAMx),ABS(LAMy),ABS(LAMz))
		IELEM(N,I)%DTL=CCFL*((IELEM(N,I)%MINEDGE)/(ABS(VELN)))
	END DO
	!$OMP END DO
	END IF
	
	IF (ITESTCASE.EQ.3)THEN
	!$OMP DO
        DO I=1,KMAXE
		LEFTV(1:NOF_vARIABLES)=U_C(I)%VAL(1,1:NOF_vARIABLES)
		
		CALL CONS2PRIM(N)
		AGRT=SQRT(LEFTV(5)*GAMMA/LEFTV(1))
		VELN=MAX(ABS(LEFTV(2)),ABS(LEFTV(3)),ABS(LEFTV(4)))+AGRT
		IELEM(N,I)%DTL=CCFL*((IELEM(N,I)%MINEDGE)/(ABS(VELN)))
	END DO
	!$OMP END DO
	END IF
	
	
	
	IF (ITESTCASE.EQ.4)THEN
	!$OMP DO SCHEDULE (STATIC)
        DO I=1,KMAXE
		LEFTV(1:NOF_vARIABLES)=U_C(I)%VAL(1,1:NOF_vARIABLES)
		CALL CONS2PRIM(N)
		RIGHTV(1:NOF_vARIABLES)=LEFTV(1:NOF_vARIABLES)
		CALL SUTHERLAND(N,LEFTV,RIGHTV)
		AGRT=SQRT(LEFTV(5)*GAMMA/LEFTV(1))
		VELN=MAX(ABS(LEFTV(2)),ABS(LEFTV(3)),ABS(LEFTV(4)))+AGRT
		IF (TURBULENCE.EQ.1)THEN
		IF (TURBULENCEMODEL.EQ.1)THEN
		TURBMV(1)=U_CT(I)%VAL(1,1);  TURBMV(2)=U_CT(I)%VAL(1,1);
		eddyfl(2)=turbmv(1); eddyfr(2)=turbmv(2)
		CALL EDDYVISCO(N,VISCL,LAML,TURBMV,ETVM,EDDYFL,EDDYFR)
		LAML(1)=LAML(1)+LAML(3)
		VISCL(1)=VISCL(1)+VISCL(3)
		END IF
		END IF
		
		
		
		
		IELEM(N,I)%DTL=CCFL*(1.0D0/((ABS(VELN)/((IELEM(N,I)%MINEDGE))) + (0.5D0*(LAML(1)+VISCL(1))/((IELEM(N,I)%MINEDGE))**2)))
		
	END DO
	!$OMP END DO
	END IF
	
	
        RETURN
        
END SUBROUTINE CALCULATE_CFLL



SUBROUTINE CALCULATE_CFL2D(N)
!> @brief
!> subroutine for computing the global time step size in 2D
IMPLICIT NONE
INTEGER,INTENT(IN)::N
INTEGER::I,K,L,KMAXE,J,INGTMAX,INGTMIN,WHGU,WHGL
REAL::SUVI,SUV3,maxU,MINU,sum_DT1,sum_dt2
REAL::CCFL,VELN,AGRT
KMAXE=XMPIELRANK(N)
       
        CCFL=(CFL/2.0d0)
        
        DT=tolbig
        
        
        
        
	IF (ITESTCASE.LT.3)THEN
	!$OMP DO REDUCTION (MIN:DT)
        DO I=1,KMAXE
        
				IF (initcond.eq.3)THEN
				  lamx=-ielem(n,i)%yyc+0.5d0
				  lamy=ielem(n,i)%xxc-0.5
				  END IF
        
        
		VELN=MAX(ABS(LAMx),ABS(LAMy))
		DT=MIN(DT,CCFL*((IELEM(N,I)%MINEDGE)/(ABS(VELN))))
		
	END DO
	!$OMP END DO
	END IF
	
	IF (ITESTCASE.EQ.3)THEN
	!$OMP DO REDUCTION (MIN:DT)
        DO I=1,KMAXE
		LEFTV(1:NOF_vARIABLES)=U_C(I)%VAL(1,1:NOF_vARIABLES)
		CALL CONS2PRIM2D(N)
		IF (multispecies.eq.1)THEN
		AGRT=SQRT((LEFTV(4)+MP_PINFL)*GAMMAl/LEFTV(1))
		ELSE
		AGRT=SQRT(LEFTV(4)*GAMMA/LEFTV(1))
		END IF
		VELN=MAX(ABS(LEFTV(2)),ABS(LEFTV(3)))+AGRT
		DT=MIN(DT,CCFL*((IELEM(N,I)%MINEDGE)/(ABS(VELN))))
		
	END DO
	!$OMP END DO
	END IF
	
	
	
	IF (ITESTCASE.EQ.4)THEN
	!$OMP DO REDUCTION (MIN:DT)
        DO I=1,KMAXE
		LEFTV(1:NOF_vARIABLES)=U_C(I)%VAL(1,1:NOF_vARIABLES)
		CALL CONS2PRIM2d2(N)
		RIGHTV(1:NOF_vARIABLES)=LEFTV(1:NOF_vARIABLES)
		CALL SUTHERLAND2D(N,LEFTV,RIGHTV)
		AGRT=SQRT(LEFTV(4)*GAMMA/LEFTV(1))
		VELN=MAX(ABS(LEFTV(2)),ABS(LEFTV(3)))+AGRT
		IF (TURBULENCE.EQ.1)THEN
		IF (TURBULENCEMODEL.EQ.1)THEN
		TURBMV(1)=U_CT(I)%VAL(1,1);  TURBMV(2)=U_CT(I)%VAL(1,1);
		eddyfl(2)=turbmv(1); eddyfr(2)=turbmv(2)
		CALL EDDYVISCO2D(N,VISCL,LAML,TURBMV,ETVM,EDDYFL,EDDYFR)
		LAML(1)=LAML(1)+LAML(3)
		VISCL(1)=VISCL(1)+VISCL(3)
		END IF
		END IF
		
		DT=MIN(DT,CCFL*(1.0D0/((ABS(VELN)/((IELEM(N,I)%MINEDGE))) + (0.5D0*(LAML(1)+VISCL(1))/((IELEM(N,I)%MINEDGE))**2))))
	END DO
	!$OMP END DO
	END IF
	
	
        RETURN
        
END SUBROUTINE CALCULATE_CFL2D


SUBROUTINE CALCULATE_CFLL2D(N)
!> @brief
!> subroutine for computing the time step size for each cell in 2D
IMPLICIT NONE
INTEGER,INTENT(IN)::N
INTEGER::I,K,L,KMAXE,J,INGTMAX,INGTMIN,WHGU,WHGL
REAL::SUVI,SUV3,maxU,MINU
REAL::CCFL,VELN,AGRT
KMAXE=XMPIELRANK(N)
       
        CCFL=(CFL/2.0d0)
        
        
	IF (ITESTCASE.LT.3)THEN
	!$OMP DO SCHEDULE (STATIC)
        DO I=1,KMAXE
		VELN=MAX(ABS(LAMx),ABS(LAMy))
		IELEM(N,I)%DTL=CCFL*((IELEM(N,I)%MINEDGE)/(ABS(VELN)))
	END DO
	!$OMP END DO
	END IF
	
	IF (ITESTCASE.EQ.3)THEN
	!$OMP DO SCHEDULE (STATIC)
        DO I=1,KMAXE
		LEFTV(1:NOF_vARIABLES)=U_C(I)%VAL(1,1:NOF_vARIABLES)
		
		CALL CONS2PRIM2D(N)
		AGRT=SQRT(LEFTV(4)*GAMMA/LEFTV(1))
		VELN=MAX(ABS(LEFTV(2)),ABS(LEFTV(3)))+AGRT
		IELEM(N,I)%DTL=CCFL*((IELEM(N,I)%MINEDGE)/(ABS(VELN)))
	END DO
	!$OMP END DO
	END IF
	
	
	
	IF (ITESTCASE.EQ.4)THEN
	!$OMP DO SCHEDULE (STATIC)
        DO I=1,KMAXE
		LEFTV(1:NOF_vARIABLES)=U_C(I)%VAL(1,1:NOF_vARIABLES)
		CALL CONS2PRIM2d2(N)
		RIGHTV(1:NOF_vARIABLES)=LEFTV(1:NOF_vARIABLES)
		CALL SUTHERLAND2D(N,LEFTV,RIGHTV)
		AGRT=SQRT(LEFTV(4)*GAMMA/LEFTV(1))
		VELN=MAX(ABS(LEFTV(2)),ABS(LEFTV(3)))+AGRT
		IF (TURBULENCE.EQ.1)THEN
		IF (TURBULENCEMODEL.EQ.1)THEN
		TURBMV(1)=U_CT(I)%VAL(1,1);  TURBMV(2)=U_CT(I)%VAL(1,1);
		eddyfl(2)=turbmv(1); eddyfr(2)=turbmv(2)
		CALL EDDYVISCO2D(N,VISCL,LAML,TURBMV,ETVM,EDDYFL,EDDYFR)
		LAML(1)=LAML(1)+LAML(3)
		VISCL(1)=VISCL(1)+VISCL(3)
		END IF
		END IF
		
		IELEM(N,I)%DTL=CCFL*(1.0D0/((ABS(VELN)/((IELEM(N,I)%MINEDGE))) + (0.5D0*(LAML(1)+VISCL(1))/((IELEM(N,I)%MINEDGE))**2)))
	END DO
	!$OMP END DO
	END IF
	
	
        RETURN
        
END SUBROUTINE CALCULATE_CFLL2D


! ! !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
! ! !---------------------------------------------------------------------------------------------!
! ! !---------------------------------------------------------------------------------------------!
! ! !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
! ! !!!!!!!!!!!!!!!!!!SUBROUTINE CALLED TO ADVANCE SOLUTION BY ONE TIME STEP SIZE!!!!!!!!!!!!!!!!!!
! ! !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
! ! !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
! ! !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
SUBROUTINE RUNGE_KUTTA3_MOOD(N)
!> @brief
!> SSP RUNGE KUTTA 3RD-ORDER SCHEME
IMPLICIT NONE
INTEGER,INTENT(IN)::N
INTEGER::I,KMAXE
REAL::AVRGS,OOVOLUME,TO4,OO4,TO3,OO3,INDS
KMAXE=XMPIELRANK(N)
TO4=3.0D0/4.0D0
OO4=1.0D0/4.0D0
TO3=2.0D0/3.0D0
OO3=1.0D0/3.0D0	


IF (MOOD.EQ.1)THEN
INDS=4
ELSE
INDS=1
END IF

IF (FASTEST.EQ.1)THEN
    CALL EXCHANGE_LOWER(N)
    CALL ARBITRARY_ORDER3(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CALL CALCULATE_FLUXESHI_DIFFUSIVE(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION(N)
    END IF
    
    END SELECT
ELSE
    CALL EXCHANGE_HIGHER(N)
    CALL ARBITRARY_ORDER3(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CALL CALCULATE_FLUXESHI_DIFFUSIVE(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION(N)
    END IF
    
    END SELECT
END IF


!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_C(I)%VAL(2,1:NOF_VARIABLES)=U_C(I)%VAL(1,1:NOF_VARIABLES)
  IF (MOOD.EQ.1)THEN
  U_C(I)%VAL(3,1:NOF_VARIABLES)=U_C(I)%VAL(1,1:NOF_VARIABLES)
  END IF
  U_C(I)%VAL(INDS,1:NOF_VARIABLES)=U_C(I)%VAL(2,1:NOF_VARIABLES)-(DT*(RHS(I)%VAL(1:NOF_VARIABLES)*OOVOLUME))
END DO
!$OMP END DO

IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_Ct(I)%VAL(2,1:turbulenceequations+passivescalar)=U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)
  U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)=U_Ct(I)%VAL(2,1:turbulenceequations+passivescalar)-(DT*(RHSt(I)%VAL(1:turbulenceequations+passivescalar)*OOVOLUME))
END DO
!$OMP END DO
 END IF
 
 IF (MOOD.EQ.1)THEN
 
 CALL MOOD_OPERATOR_2(N)
   !$OMP DO
DO I=1,KMAXE
    IF (IELEM(N,I)%RECALC.EQ.1)THEN
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_C(I)%VAL(INDS,1:NOF_VARIABLES)=U_C(I)%VAL(2,1:NOF_VARIABLES)-(DT*(RHS(I)%VAL(1:NOF_VARIABLES)*OOVOLUME))
   IELEM(N,I)%MOOD_O=2
   END IF
END DO
!$OMP END DO

CALL MOOD_OPERATOR_1(N)

   !$OMP DO
DO I=1,KMAXE
    IF (IELEM(N,I)%RECALC.EQ.1)THEN
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_C(I)%VAL(1,1:NOF_VARIABLES)=U_C(I)%VAL(2,1:NOF_VARIABLES)-(DT*(RHS(I)%VAL(1:NOF_VARIABLES)*OOVOLUME))
    IELEM(N,I)%MOOD_O=1
   ELSE
   U_C(I)%VAL(1,1:NOF_VARIABLES)=U_C(I)%VAL(4,1:NOF_VARIABLES)
   END IF
END DO
!$OMP END DO

END IF

 
IF (FASTEST.EQ.1)THEN
    CALL EXCHANGE_LOWER(N)
    CALL ARBITRARY_ORDER3(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CALL CALCULATE_FLUXESHI_DIFFUSIVE(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION(N)
    END IF
    END SELECT
ELSE
    CALL EXCHANGE_HIGHER(N)
    CALL ARBITRARY_ORDER3(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CALL CALCULATE_FLUXESHI_DIFFUSIVE(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION(N)
    END IF
    END SELECT
END IF

!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_C(I)%VAL(3,1:NOF_VARIABLES)=U_C(I)%VAL(1,1:NOF_VARIABLES)
  U_C(I)%VAL(inds,1:NOF_VARIABLES)=(TO4*U_C(I)%VAL(2,1:NOF_VARIABLES))+(OO4*U_C(I)%VAL(3,1:NOF_VARIABLES))-(((OO4))*((DT)*&
((RHS(I)%VAL(1:NOF_VARIABLES))*(OOVOLUME))))
END DO
!$OMP END DO






IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_Ct(I)%VAL(3,1:turbulenceequations+passivescalar)=U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)
  U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)=(TO4*U_Ct(I)%VAL(2,1:turbulenceequations+passivescalar))+(OO4*U_Ct(I)%VAL(3,1:turbulenceequations+passivescalar))-(((OO4))*((DT)*&
((RHSt(I)%VAL(1:turbulenceequations+passivescalar))*(OOVOLUME))))
END DO
!$OMP END DO
 END IF

 IF (MOOD.EQ.1)THEN
 
 CALL MOOD_OPERATOR_2(N)
   !$OMP DO
DO I=1,KMAXE
    IF (IELEM(N,I)%RECALC.EQ.1)THEN
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_C(I)%VAL(INDS,1:NOF_VARIABLES)=(TO4*U_C(I)%VAL(2,1:NOF_VARIABLES))+(OO4*U_C(I)%VAL(3,1:NOF_VARIABLES))-(((OO4))*((DT)*&
((RHS(I)%VAL(1:NOF_VARIABLES))*(OOVOLUME))))
   IELEM(N,I)%MOOD_O=2
   END IF
END DO
!$OMP END DO

CALL MOOD_OPERATOR_1(N)

   !$OMP DO
DO I=1,KMAXE
    IF (IELEM(N,I)%RECALC.EQ.1)THEN
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_C(I)%VAL(1,1:NOF_VARIABLES)=(TO4*U_C(I)%VAL(2,1:NOF_VARIABLES))+(OO4*U_C(I)%VAL(3,1:NOF_VARIABLES))-(((OO4))*((DT)*&
((RHS(I)%VAL(1:NOF_VARIABLES))*(OOVOLUME))))
    IELEM(N,I)%MOOD_O=1
   ELSE
   U_C(I)%VAL(1,1:NOF_VARIABLES)=U_C(I)%VAL(4,1:NOF_VARIABLES)
   END IF
END DO
!$OMP END DO

END IF
 

IF (FASTEST.EQ.1)THEN
    CALL EXCHANGE_LOWER(N)
    CALL ARBITRARY_ORDER3(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CALL CALCULATE_FLUXESHI_DIFFUSIVE(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION(N)
    END IF
    END SELECT
ELSE
    CALL EXCHANGE_HIGHER(N)
    CALL ARBITRARY_ORDER3(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CALL CALCULATE_FLUXESHI_DIFFUSIVE(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION(N)
    END IF
    CALL VORTEXCALC(N)
    END SELECT
END IF
!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
   IF (MOOD.EQ.1)THEN
  U_C(I)%VAL(3,1:NOF_VARIABLES)=U_C(I)%VAL(1,1:NOF_VARIABLES)
  END IF
  U_C(I)%VAL(INDS,1:NOF_VARIABLES)=((OO3)*U_C(I)%VAL(2,1:NOF_VARIABLES))+((TO3)*U_C(I)%VAL(1,1:NOF_VARIABLES))-(((TO3))*&
((DT)*((RHS(I)%VAL(1:NOF_VARIABLES))*(OOVOLUME))))
END DO
!$OMP END DO


IF (MOOD.EQ.1)THEN
 
 CALL MOOD_OPERATOR_2(N)
   !$OMP DO
DO I=1,KMAXE
    IF (IELEM(N,I)%RECALC.EQ.1)THEN
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_C(I)%VAL(INDS,1:NOF_VARIABLES)=((OO3)*U_C(I)%VAL(2,1:NOF_VARIABLES))+((TO3)*U_C(I)%VAL(1,1:NOF_VARIABLES))-(((TO3))*&
((DT)*((RHS(I)%VAL(1:NOF_VARIABLES))*(OOVOLUME))))
   IELEM(N,I)%MOOD_O=2
   END IF
END DO
!$OMP END DO

CALL MOOD_OPERATOR_1(N)

   !$OMP DO
DO I=1,KMAXE
    IF (IELEM(N,I)%RECALC.EQ.1)THEN
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_C(I)%VAL(1,1:NOF_VARIABLES)=((OO3)*U_C(I)%VAL(2,1:NOF_VARIABLES))+((TO3)*U_C(I)%VAL(1,1:NOF_VARIABLES))-(((TO3))*&
((DT)*((RHS(I)%VAL(1:NOF_VARIABLES))*(OOVOLUME))))
    IELEM(N,I)%MOOD_O=1
   ELSE
   U_C(I)%VAL(1,1:NOF_VARIABLES)=U_C(I)%VAL(4,1:NOF_VARIABLES)
   END IF
END DO
!$OMP END DO

END IF


IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)=((OO3)*U_Ct(I)%VAL(2,1:turbulenceequations+passivescalar))+((TO3)*U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar))-(((TO3))*&
((DT)*((RHSt(I)%VAL(1:turbulenceequations+passivescalar))*(OOVOLUME))))
END DO
!$OMP END DO
 END IF



IF (AVERAGING.EQ.1)THEN

 CALL AVERAGING_T(N)
 
END IF





                        
END SUBROUTINE RUNGE_KUTTA3_MOOD


SUBROUTINE RUNGE_KUTTA3(N)
!> @brief
!> SSP RUNGE KUTTA 3RD-ORDER SCHEME
IMPLICIT NONE
INTEGER,INTENT(IN)::N
INTEGER::I,KMAXE
REAL::AVRGS,OOVOLUME,TO4,OO4,TO3,OO3
KMAXE=XMPIELRANK(N)
TO4=3.0D0/4.0D0
OO4=1.0D0/4.0D0
TO3=2.0D0/3.0D0
OO3=1.0D0/3.0D0	

IF (FASTEST.EQ.1)THEN
    CALL EXCHANGE_LOWER(N)
    CALL ARBITRARY_ORDER3(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CALL CALCULATE_FLUXESHI_DIFFUSIVE(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION(N)
    END IF
    
    END SELECT
ELSE
    CALL EXCHANGE_HIGHER(N)
    CALL ARBITRARY_ORDER3(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CALL CALCULATE_FLUXESHI_DIFFUSIVE(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION(N)
    END IF
    
    END SELECT
END IF


!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_C(I)%VAL(2,1:NOF_VARIABLES)=U_C(I)%VAL(1,1:NOF_VARIABLES)
  U_C(I)%VAL(1,1:NOF_VARIABLES)=U_C(I)%VAL(2,1:NOF_VARIABLES)-(DT*(RHS(I)%VAL(1:NOF_VARIABLES)*OOVOLUME))
END DO
!$OMP END DO

IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_Ct(I)%VAL(2,1:turbulenceequations+passivescalar)=U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)
  U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)=U_Ct(I)%VAL(2,1:turbulenceequations+passivescalar)-(DT*(RHSt(I)%VAL(1:turbulenceequations+passivescalar)*OOVOLUME))
END DO
!$OMP END DO
 END IF
 
IF (FASTEST.EQ.1)THEN
    CALL EXCHANGE_LOWER(N)
    CALL ARBITRARY_ORDER3(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CALL CALCULATE_FLUXESHI_DIFFUSIVE(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION(N)
    END IF
    END SELECT
ELSE
    CALL EXCHANGE_HIGHER(N)
    CALL ARBITRARY_ORDER3(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CALL CALCULATE_FLUXESHI_DIFFUSIVE(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION(N)
    END IF
    END SELECT
END IF

!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_C(I)%VAL(3,1:NOF_VARIABLES)=U_C(I)%VAL(1,1:NOF_VARIABLES)
  U_C(I)%VAL(1,1:NOF_VARIABLES)=(TO4*U_C(I)%VAL(2,1:NOF_VARIABLES))+(OO4*U_C(I)%VAL(3,1:NOF_VARIABLES))-(((OO4))*((DT)*&
((RHS(I)%VAL(1:NOF_VARIABLES))*(OOVOLUME))))
END DO
!$OMP END DO

IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_Ct(I)%VAL(3,1:turbulenceequations+passivescalar)=U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)
  U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)=(TO4*U_Ct(I)%VAL(2,1:turbulenceequations+passivescalar))+(OO4*U_Ct(I)%VAL(3,1:turbulenceequations+passivescalar))-(((OO4))*((DT)*&
((RHSt(I)%VAL(1:turbulenceequations+passivescalar))*(OOVOLUME))))
END DO
!$OMP END DO
 END IF



IF (FASTEST.EQ.1)THEN
    CALL EXCHANGE_LOWER(N)
    CALL ARBITRARY_ORDER3(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CALL CALCULATE_FLUXESHI_DIFFUSIVE(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION(N)
    END IF
    END SELECT
ELSE
    CALL EXCHANGE_HIGHER(N)
    CALL ARBITRARY_ORDER3(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CALL CALCULATE_FLUXESHI_DIFFUSIVE(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION(N)
    END IF
    CALL VORTEXCALC(N)
    END SELECT
END IF
!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_C(I)%VAL(1,1:NOF_VARIABLES)=((OO3)*U_C(I)%VAL(2,1:NOF_VARIABLES))+((TO3)*U_C(I)%VAL(1,1:NOF_VARIABLES))-(((TO3))*&
((DT)*((RHS(I)%VAL(1:NOF_VARIABLES))*(OOVOLUME))))
END DO
!$OMP END DO

IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)=((OO3)*U_Ct(I)%VAL(2,1:turbulenceequations+passivescalar))+((TO3)*U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar))-(((TO3))*&
((DT)*((RHSt(I)%VAL(1:turbulenceequations+passivescalar))*(OOVOLUME))))
END DO
!$OMP END DO
 END IF



IF (AVERAGING.EQ.1)THEN

 CALL AVERAGING_T(N)
 
END IF





                        
END SUBROUTINE RUNGE_KUTTA3




SUBROUTINE RUNGE_KUTTA1(N)
!> @brief
!> SSP FORWARD EULER SCHEME
IMPLICIT NONE
INTEGER,INTENT(IN)::N
INTEGER::I,KMAXE
REAL::AVRGS,OOVOLUME,TO4,OO4,TO3,OO3
reaL::t1,t2,t3
KMAXE=XMPIELRANK(N)




IF (FASTEST.EQ.1)THEN
    CALL EXCHANGE_LOWER(N)
    CALL ARBITRARY_ORDER3(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CALL CALCULATE_FLUXESHI_DIFFUSIVE(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION(N)
    END IF
    END SELECT
ELSE
   
    
    CALL EXCHANGE_HIGHER(N)
       CALL ARBITRARY_ORDER3(N)
   
    CALL EXHBOUNDHIGHER(N)
    
    
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CALL CALCULATE_FLUXESHI_DIFFUSIVE(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION(N)
    END IF
    CALL VORTEXCALC(N)
    END SELECT
END IF



!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  
  U_C(I)%VAL(1,1:NOF_VARIABLES)=U_C(I)%VAL(1,1:NOF_VARIABLES)-(DT*(RHS(I)%VAL(1:NOF_VARIABLES)*OOVOLUME))
  
END DO
!$OMP END DO

IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)=U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)-(DT*(RHSt(I)%VAL(1:turbulenceequations+passivescalar)*OOVOLUME))
END DO
!$OMP END DO
 END IF




IF (AVERAGING.EQ.1)THEN

 CALL AVERAGING_T(N)
 
END IF





                        
END SUBROUTINE RUNGE_KUTTA1



SUBROUTINE RUNGE_KUTTA2(N)
!> @brief
!> SSP RUNGE KUTTA 2ND-ORDER SCHEME
IMPLICIT NONE
INTEGER,INTENT(IN)::N
INTEGER::I,KMAXE
REAL::AVRGS,OOVOLUME,TO4,OO4,TO3,OO3
KMAXE=XMPIELRANK(N)
TO4=3.0D0/4.0D0
OO4=1.0D0/4.0D0
TO3=2.0D0/3.0D0
OO3=1.0D0/3.0D0	

IF (FASTEST.EQ.1)THEN
    CALL EXCHANGE_LOWER(N)
    CALL ARBITRARY_ORDER3(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CALL CALCULATE_FLUXESHI_DIFFUSIVE(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION(N)
    END IF
    END SELECT
ELSE
    CALL EXCHANGE_HIGHER(N)
    CALL ARBITRARY_ORDER3(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CALL CALCULATE_FLUXESHI_DIFFUSIVE(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION(N)
    END IF
    END SELECT
END IF


!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_C(I)%VAL(2,1:NOF_VARIABLES)=U_C(I)%VAL(1,1:NOF_VARIABLES)
  U_C(I)%VAL(1,1:NOF_VARIABLES)=U_C(I)%VAL(1,1:NOF_VARIABLES)-(DT*(RHS(I)%VAL(1:NOF_VARIABLES)*OOVOLUME))
  
END DO
!$OMP END DO
IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_Ct(I)%VAL(2,1:turbulenceequations+passivescalar)=U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)
  U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)=U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)-(DT*(RHSt(I)%VAL(1:turbulenceequations+passivescalar)*OOVOLUME))
END DO
!$OMP END DO
 END IF



IF (FASTEST.EQ.1)THEN
    CALL EXCHANGE_LOWER(N)
    CALL ARBITRARY_ORDER3(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CALL CALCULATE_FLUXESHI_DIFFUSIVE(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION(N)
    END IF
    END SELECT
ELSE
    CALL EXCHANGE_HIGHER(N)
    CALL ARBITRARY_ORDER3(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CALL CALCULATE_FLUXESHI_DIFFUSIVE(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION(N)
    END IF
    CALL VORTEXCALC(N)
    END SELECT
END IF

!$OMP DO
DO I=1,KMAXE
 OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_C(I)%VAL(1,1:NOF_VARIABLES)=(oo2*U_C(I)%VAL(2,1:NOF_VARIABLES))+(oo2*U_C(I)%VAL(1,1:NOF_VARIABLES))-(dt*oo2*(RHS(I)%VAL(1:NOF_VARIABLES)*OOVOLUME))
END DO
!$OMP END DO

IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)=(oo2*U_Ct(I)%VAL(2,1:turbulenceequations+passivescalar))+(oo2*U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar))-(dt*oo2*(RHSt(I)%VAL(1:turbulenceequations+passivescalar)*OOVOLUME))
  END DO
!$OMP END DO
 END IF







IF (AVERAGING.EQ.1)THEN

 CALL AVERAGING_T(N)
 
END IF





                        
END SUBROUTINE RUNGE_KUTTA2


SUBROUTINE RUNGE_KUTTA5(N)
!> @brief
!> SSP RUNGE KUTTA 2ND-ORDER SCHEME FOR LOCAL TIME STEPPING
IMPLICIT NONE
INTEGER,INTENT(IN)::N
INTEGER::I,KMAXE
REAL::AVRGS,OOVOLUME,TO4,OO4,TO3,OO3
KMAXE=XMPIELRANK(N)


IF (FASTEST.EQ.1)THEN
    CALL EXCHANGE_LOWER(N)
    CALL ARBITRARY_ORDER3(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CALL CALCULATE_FLUXESHI_DIFFUSIVE(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION(N)
    END IF
    END SELECT
ELSE
    CALL EXCHANGE_HIGHER(N)
    CALL ARBITRARY_ORDER3(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CALL CALCULATE_FLUXESHI_DIFFUSIVE(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION(N)
    END IF
    END SELECT
END IF


!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_C(I)%VAL(2,1:NOF_VARIABLES)=U_C(I)%VAL(1,1:NOF_VARIABLES)
  U_C(I)%VAL(1,1:NOF_VARIABLES)=U_C(I)%VAL(1,1:NOF_VARIABLES)-(ielem(n,i)%dtl*(RHS(I)%VAL(1:NOF_VARIABLES)*OOVOLUME))
  
END DO
!$OMP END DO

IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_Ct(I)%VAL(2,1:turbulenceequations+passivescalar)=U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)
  U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)=U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)-(ielem(n,i)%dtl*(RHSt(I)%VAL(1:turbulenceequations+passivescalar)*OOVOLUME))
  END DO
!$OMP END DO
 END IF


IF (FASTEST.EQ.1)THEN
    CALL EXCHANGE_LOWER(N)
    CALL ARBITRARY_ORDER3(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CALL CALCULATE_FLUXESHI_DIFFUSIVE(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION(N)
    END IF
    END SELECT
ELSE
    CALL EXCHANGE_HIGHER(N)
    CALL ARBITRARY_ORDER3(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CALL CALCULATE_FLUXESHI_DIFFUSIVE(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION(N)
    END IF
    CALL VORTEXCALC(N)
    END SELECT
END IF

!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  
  U_C(I)%VAL(1,1:NOF_VARIABLES)=(oo2*U_C(I)%VAL(2,1:NOF_VARIABLES))+(oo2*U_C(I)%VAL(1,1:NOF_VARIABLES))-(ielem(n,i)%dtl*oo2*(RHS(I)%VAL(1:NOF_VARIABLES)*OOVOLUME))
END DO
!$OMP END DO

IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)=(oo2*U_Ct(I)%VAL(2,1:turbulenceequations+passivescalar))+(oo2*U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar))-(ielem(n,i)%dtl*oo2*(RHSt(I)%VAL(1:turbulenceequations+passivescalar)*OOVOLUME))
  END DO
!$OMP END DO
 END IF


IF (AVERAGING.EQ.1)THEN

 CALL AVERAGING_T(N)
 
END IF





                        
END SUBROUTINE RUNGE_KUTTA5

SUBROUTINE RUNGE_KUTTA5_2D(N)
!> @brief
!> SSP RUNGE KUTTA 2ND-ORDER SCHEME FOR LOCAL TIME STEPPING IN 2D
IMPLICIT NONE
INTEGER,INTENT(IN)::N
INTEGER::I,KMAXE
REAL::AVRGS,OOVOLUME,TO4,OO4,TO3,OO3
KMAXE=XMPIELRANK(N)


IF (FASTEST.EQ.1)THEN
    CALL EXCHANGE_LOWER(N)
    CALL ARBITRARY_ORDER2(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI2D(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2D(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2D(N)
    CALL CALCULATE_FLUXESHI_DIFFUSIVE2D(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION2d(N)
    END IF
    END SELECT
ELSE
    CALL EXCHANGE_HIGHER(N)
    CALL ARBITRARY_ORDER2(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI2D(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2D(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2D(N)
    CALL CALCULATE_FLUXESHI_DIFFUSIVE2D(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION2d(N)
    END IF
    END SELECT
END IF


!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_C(I)%VAL(2,1:NOF_VARIABLES)=U_C(I)%VAL(1,1:NOF_VARIABLES)
  U_C(I)%VAL(1,1:NOF_VARIABLES)=U_C(I)%VAL(1,1:NOF_VARIABLES)-(ielem(n,i)%dtl*(RHS(I)%VAL(1:NOF_VARIABLES)*OOVOLUME))
  
END DO
!$OMP END DO

IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_Ct(I)%VAL(2,1:turbulenceequations+passivescalar)=U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)
  U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)=U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)-(ielem(n,i)%dtl*(RHSt(I)%VAL(1:turbulenceequations+passivescalar)*OOVOLUME))
  END DO
!$OMP END DO
 END IF



IF (FASTEST.EQ.1)THEN
    CALL EXCHANGE_LOWER(N)
    CALL ARBITRARY_ORDER2(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI2D(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2D(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2D(N)
    CALL CALCULATE_FLUXESHI_DIFFUSIVE2D(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION2d(N)
    END IF
    CALL VORTEXCALC2D(N)
    END SELECT
ELSE
    CALL EXCHANGE_HIGHER(N)
    CALL ARBITRARY_ORDER2(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI2D(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2D(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2D(N)
    CALL CALCULATE_FLUXESHI_DIFFUSIVE2D(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION2d(N)
    END IF
    CALL VORTEXCALC2D(N)
    END SELECT
END IF

!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_C(I)%VAL(1,1:NOF_VARIABLES)=(oo2*U_C(I)%VAL(2,1:NOF_VARIABLES))+(oo2*U_C(I)%VAL(1,1:NOF_VARIABLES))-(ielem(n,i)%dtl*oo2*(RHS(I)%VAL(1:NOF_VARIABLES)*OOVOLUME))
END DO
!$OMP END DO

IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)=(oo2*U_Ct(I)%VAL(2,1:turbulenceequations+passivescalar))+(oo2*U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar))-(ielem(n,i)%dtl*oo2*(RHSt(I)%VAL(1:turbulenceequations+passivescalar)*OOVOLUME))
  END DO
!$OMP END DO
 END IF



IF (AVERAGING.EQ.1)THEN

 CALL AVERAGING_T(N)
 
END IF





                        
END SUBROUTINE RUNGE_KUTTA5_2D


SUBROUTINE RUNGE_KUTTA2_2D(N)
!> @brief
!> SSP RUNGE KUTTA 2ND-ORDER SCHEME IN 2D
IMPLICIT NONE
INTEGER,INTENT(IN)::N
INTEGER::I,KMAXE
REAL::AVRGS,OOVOLUME,TO4,OO4,TO3,OO3
KMAXE=XMPIELRANK(N)


IF (FASTEST.EQ.1)THEN
    CALL EXCHANGE_LOWER(N)
    CALL ARBITRARY_ORDER2(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI2D(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2D(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2D(N)
    CALL CALCULATE_FLUXESHI_DIFFUSIVE2D(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION2d(N)
    END IF
    END SELECT
ELSE
    CALL EXCHANGE_HIGHER(N)
    CALL ARBITRARY_ORDER2(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI2D(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2D(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2D(N)
    CALL CALCULATE_FLUXESHI_DIFFUSIVE2D(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION2d(N)
    END IF
    END SELECT
END IF


!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_C(I)%VAL(2,1:NOF_VARIABLES)=U_C(I)%VAL(1,1:NOF_VARIABLES)
  U_C(I)%VAL(1,1:NOF_VARIABLES)=U_C(I)%VAL(2,1:NOF_VARIABLES)-(dt*(RHS(I)%VAL(1:NOF_VARIABLES)*OOVOLUME))
  
END DO
!$OMP END DO


IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_Ct(I)%VAL(2,1:turbulenceequations+passivescalar)=U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)
  U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)=U_Ct(I)%VAL(2,1:turbulenceequations+passivescalar)-(dt*(RHSt(I)%VAL(1:turbulenceequations+passivescalar)*OOVOLUME))
  END DO
!$OMP END DO
 END IF


IF (FASTEST.EQ.1)THEN
    CALL EXCHANGE_LOWER(N)
    CALL ARBITRARY_ORDER2(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI2D(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2D(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2D(N)
    CALL CALCULATE_FLUXESHI_DIFFUSIVE2D(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION2d(N)
    END IF
    END SELECT
ELSE
    CALL EXCHANGE_HIGHER(N)
    CALL ARBITRARY_ORDER2(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI2D(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2D(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2D(N)
    CALL CALCULATE_FLUXESHI_DIFFUSIVE2D(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION2d(N)
    END IF
    CALL VORTEXCALC2D(N)
    END SELECT
END IF

!$OMP DO
DO I=1,KMAXE
 OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_C(I)%VAL(1,1:NOF_VARIABLES)=(oo2*U_C(I)%VAL(2,1:NOF_VARIABLES))+(oo2*U_C(I)%VAL(1,1:NOF_VARIABLES))-(dt*oo2*(RHS(I)%VAL(1:NOF_VARIABLES)*OOVOLUME))
END DO
!$OMP END DO

IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)=(U_Ct(I)%VAL(2,1:turbulenceequations+passivescalar))-(dt*(RHSt(I)%VAL(1:turbulenceequations+passivescalar)*OOVOLUME))
  END DO
!$OMP END DO
 END IF



IF (AVERAGING.EQ.1)THEN

 CALL AVERAGING_T(N)
 
END IF





                        
END SUBROUTINE RUNGE_KUTTA2_2D



SUBROUTINE RUNGE_KUTTA1_2D(N)
!> @brief
!> SSP FORWARD EULER SCHEME IN 2D
IMPLICIT NONE
INTEGER,INTENT(IN)::N
INTEGER::I,KMAXE
REAL::AVRGS,OOVOLUME,TO4,OO4,TO3,OO3
KMAXE=XMPIELRANK(N)


IF (FASTEST.EQ.1)THEN
    CALL EXCHANGE_LOWER(N)
    CALL ARBITRARY_ORDER2(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI2D(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2D(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2D(N)
    CALL CALCULATE_FLUXESHI_DIFFUSIVE2D(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION2d(N)
    END IF
    END SELECT
ELSE
    CALL EXCHANGE_HIGHER(N)
    CALL ARBITRARY_ORDER2(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI2D(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2D(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2D(N)
    CALL CALCULATE_FLUXESHI_DIFFUSIVE2D(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION2d(N)
    END IF
    CALL VORTEXCALC2D(N)
    END SELECT
END IF



!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_C(I)%VAL(1,1:NOF_VARIABLES)=U_C(I)%VAL(1,1:NOF_VARIABLES)-(dt*(RHS(I)%VAL(1:NOF_VARIABLES)*OOVOLUME))
  
END DO
!$OMP END DO

IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)=U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)-(dt*(RHSt(I)%VAL(1:turbulenceequations+passivescalar)*OOVOLUME))
  END DO
!$OMP END DO
 END IF



IF (AVERAGING.EQ.1)THEN

 CALL AVERAGING_T(N)
 
END IF





                        
END SUBROUTINE RUNGE_KUTTA1_2D


SUBROUTINE RUNGE_KUTTA3_2D(N)
!> @brief
!> SSP RUNGE KUTTA 3RD-ORDER SCHEME IN 2D
IMPLICIT NONE
INTEGER,INTENT(IN)::N
INTEGER::I,KMAXE
REAL::AVRGS,OOVOLUME,TO4,OO4,TO3,OO3
KMAXE=XMPIELRANK(N)
TO4=3.0D0/4.0D0
OO4=1.0D0/4.0D0
TO3=2.0D0/3.0D0
OO3=1.0D0/3.0D0	

IF (FASTEST.EQ.1)THEN
    CALL EXCHANGE_LOWER(N)
    CALL ARBITRARY_ORDER2(N)
    CALL EXHBOUNDHIGHER(N)
    
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI2D(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2d(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2d(N)
    CALL CALCULATE_FLUXESHI_dIFfusive2d(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION2d(N)
    END IF
    END SELECT
    
ELSE
    CALL EXCHANGE_HIGHER(N)
    CALL ARBITRARY_ORDER2(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI2D(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2d(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2d(N)
    CALL CALCULATE_FLUXESHI_dIFfusive2d(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION2d(N)
    END IF
    END SELECT
END IF


!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_C(I)%VAL(2,1:NOF_VARIABLES)=U_C(I)%VAL(1,1:NOF_VARIABLES)
  U_C(I)%VAL(1,1:NOF_VARIABLES)=U_C(I)%VAL(2,1:NOF_VARIABLES)-(DT*(RHS(I)%VAL(1:NOF_VARIABLES)*OOVOLUME))
  
END DO
!$OMP END DO

IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_Ct(I)%VAL(2,1:turbulenceequations+passivescalar)=U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)
  U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)=U_Ct(I)%VAL(2,1:turbulenceequations+passivescalar)-(DT*(RHSt(I)%VAL(1:turbulenceequations+passivescalar)*OOVOLUME))
  END DO
!$OMP END DO
 END IF


IF (FASTEST.EQ.1)THEN
    CALL EXCHANGE_LOWER(N)
    CALL ARBITRARY_ORDER2(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI2D(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2d(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2d(N)
    CALL CALCULATE_FLUXESHI_dIFfusive2d(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION2d(N)
    END IF
    END SELECT
ELSE
    CALL EXCHANGE_HIGHER(N)
    CALL ARBITRARY_ORDER2(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI2D(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2d(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2d(N)
    CALL CALCULATE_FLUXESHI_dIFfusive2d(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION2d(N)
    END IF
    END SELECT
END IF

!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_C(I)%VAL(3,1:NOF_VARIABLES)=U_C(I)%VAL(1,1:NOF_VARIABLES)
  U_C(I)%VAL(1,1:NOF_VARIABLES)=(TO4*U_C(I)%VAL(2,1:NOF_VARIABLES))+(OO4*U_C(I)%VAL(3,1:NOF_VARIABLES))-(((OO4))*((DT)*&
((RHS(I)%VAL(1:NOF_VARIABLES))*(OOVOLUME))))
END DO
!$OMP END DO

IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_Ct(I)%VAL(3,1:turbulenceequations+passivescalar)=U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)
  U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)=(TO4*U_Ct(I)%VAL(2,1:turbulenceequations+passivescalar))+(OO4*U_Ct(I)%VAL(3,1:turbulenceequations+passivescalar))-(((OO4))*((DT)*&
((RHSt(I)%VAL(1:turbulenceequations+passivescalar))*(OOVOLUME))))
  END DO
!$OMP END DO
 END IF



IF (FASTEST.EQ.1)THEN
    CALL EXCHANGE_LOWER(N)
    CALL ARBITRARY_ORDER2(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI2D(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2d(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2d(N)
    CALL CALCULATE_FLUXESHI_dIFfusive2d(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION2d(N)
    END IF
    END SELECT
ELSE
    CALL EXCHANGE_HIGHER(N)
    CALL ARBITRARY_ORDER2(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI2D(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2d(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2d(N)
    CALL CALCULATE_FLUXESHI_dIFfusive2d(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION2d(N)
    END IF
    CALL VORTEXCALC2D(N)
    END SELECT
END IF
!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_C(I)%VAL(1,1:NOF_VARIABLES)=((OO3)*U_C(I)%VAL(2,1:NOF_VARIABLES))+((TO3)*U_C(I)%VAL(1,1:NOF_VARIABLES))-(((TO3))*&
((DT)*((RHS(I)%VAL(1:NOF_VARIABLES))*(OOVOLUME))))
END DO
!$OMP END DO


IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)=((OO3)*U_Ct(I)%VAL(2,1:turbulenceequations+passivescalar))+((TO3)*U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar))-(((TO3))*&
((DT)*((RHSt(I)%VAL(1:turbulenceequations+passivescalar))*(OOVOLUME))))
  END DO
!$OMP END DO
 END IF




IF (AVERAGING.EQ.1)THEN

 CALL AVERAGING_T(N)
 
END IF


END SUBROUTINE RUNGE_KUTTA3_2D

SUBROUTINE RUNGE_KUTTA3_2D_MOOD(N)
!> @brief
!> SSP RUNGE KUTTA 3RD-ORDER SCHEME
IMPLICIT NONE
INTEGER,INTENT(IN)::N
INTEGER::I,KMAXE
REAL::AVRGS,OOVOLUME,TO4,OO4,TO3,OO3,INDS
KMAXE=XMPIELRANK(N)
TO4=3.0D0/4.0D0
OO4=1.0D0/4.0D0
TO3=2.0D0/3.0D0
OO3=1.0D0/3.0D0	


IF (MOOD.EQ.1)THEN
INDS=4
ELSE
INDS=1
END IF

IF (FASTEST.EQ.1)THEN
    CALL EXCHANGE_LOWER(N)
    CALL ARBITRARY_ORDER2(N)
    CALL EXHBOUNDHIGHER(N)
    
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI2D(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2d(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2d(N)
    CALL CALCULATE_FLUXESHI_dIFfusive2d(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION2d(N)
    END IF
    END SELECT
    
ELSE
    CALL EXCHANGE_HIGHER(N)
    CALL ARBITRARY_ORDER2(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI2D(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2d(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2d(N)
    CALL CALCULATE_FLUXESHI_dIFfusive2d(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION2d(N)
    END IF
    END SELECT
END IF


!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_C(I)%VAL(2,1:NOF_VARIABLES)=U_C(I)%VAL(1,1:NOF_VARIABLES)
  IF (MOOD.EQ.1)THEN
  U_C(I)%VAL(3,1:NOF_VARIABLES)=U_C(I)%VAL(1,1:NOF_VARIABLES)
  END IF
  U_C(I)%VAL(INDS,1:NOF_VARIABLES)=U_C(I)%VAL(2,1:NOF_VARIABLES)-(DT*(RHS(I)%VAL(1:NOF_VARIABLES)*OOVOLUME))
END DO
!$OMP END DO

IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_Ct(I)%VAL(2,1:turbulenceequations+passivescalar)=U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)
  U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)=U_Ct(I)%VAL(2,1:turbulenceequations+passivescalar)-(DT*(RHSt(I)%VAL(1:turbulenceequations+passivescalar)*OOVOLUME))
END DO
!$OMP END DO
 END IF
 
 IF (MOOD.EQ.1)THEN
 
 CALL MOOD_OPERATOR_2(N)
   !$OMP DO
DO I=1,KMAXE
    IF (IELEM(N,I)%RECALC.EQ.1)THEN
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_C(I)%VAL(INDS,1:NOF_VARIABLES)=U_C(I)%VAL(2,1:NOF_VARIABLES)-(DT*(RHS(I)%VAL(1:NOF_VARIABLES)*OOVOLUME))
   IELEM(N,I)%MOOD_O=2
   END IF
END DO
!$OMP END DO

CALL MOOD_OPERATOR_1(N)

   !$OMP DO
DO I=1,KMAXE
    IF (IELEM(N,I)%RECALC.EQ.1)THEN
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_C(I)%VAL(1,1:NOF_VARIABLES)=U_C(I)%VAL(2,1:NOF_VARIABLES)-(DT*(RHS(I)%VAL(1:NOF_VARIABLES)*OOVOLUME))
    IELEM(N,I)%MOOD_O=1
   ELSE
   U_C(I)%VAL(1,1:NOF_VARIABLES)=U_C(I)%VAL(4,1:NOF_VARIABLES)
   END IF
END DO
!$OMP END DO

END IF

 

IF (FASTEST.EQ.1)THEN
    CALL EXCHANGE_LOWER(N)
    CALL ARBITRARY_ORDER2(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI2D(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2d(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2d(N)
    CALL CALCULATE_FLUXESHI_dIFfusive2d(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION2d(N)
    END IF
    END SELECT
ELSE
    CALL EXCHANGE_HIGHER(N)
    CALL ARBITRARY_ORDER2(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI2D(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2d(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2d(N)
    CALL CALCULATE_FLUXESHI_dIFfusive2d(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION2d(N)
    END IF
    END SELECT
END IF

!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_C(I)%VAL(3,1:NOF_VARIABLES)=U_C(I)%VAL(1,1:NOF_VARIABLES)
  U_C(I)%VAL(inds,1:NOF_VARIABLES)=(TO4*U_C(I)%VAL(2,1:NOF_VARIABLES))+(OO4*U_C(I)%VAL(3,1:NOF_VARIABLES))-(((OO4))*((DT)*&
((RHS(I)%VAL(1:NOF_VARIABLES))*(OOVOLUME))))
END DO
!$OMP END DO






IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_Ct(I)%VAL(3,1:turbulenceequations+passivescalar)=U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)
  U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)=(TO4*U_Ct(I)%VAL(2,1:turbulenceequations+passivescalar))+(OO4*U_Ct(I)%VAL(3,1:turbulenceequations+passivescalar))-(((OO4))*((DT)*&
((RHSt(I)%VAL(1:turbulenceequations+passivescalar))*(OOVOLUME))))
END DO
!$OMP END DO
 END IF

 IF (MOOD.EQ.1)THEN
 
 CALL MOOD_OPERATOR_2(N)
   !$OMP DO
DO I=1,KMAXE
    IF (IELEM(N,I)%RECALC.EQ.1)THEN
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_C(I)%VAL(INDS,1:NOF_VARIABLES)=(TO4*U_C(I)%VAL(2,1:NOF_VARIABLES))+(OO4*U_C(I)%VAL(3,1:NOF_VARIABLES))-(((OO4))*((DT)*&
((RHS(I)%VAL(1:NOF_VARIABLES))*(OOVOLUME))))
   IELEM(N,I)%MOOD_O=2
   END IF
END DO
!$OMP END DO

CALL MOOD_OPERATOR_1(N)

   !$OMP DO
DO I=1,KMAXE
    IF (IELEM(N,I)%RECALC.EQ.1)THEN
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_C(I)%VAL(1,1:NOF_VARIABLES)=(TO4*U_C(I)%VAL(2,1:NOF_VARIABLES))+(OO4*U_C(I)%VAL(3,1:NOF_VARIABLES))-(((OO4))*((DT)*&
((RHS(I)%VAL(1:NOF_VARIABLES))*(OOVOLUME))))
    IELEM(N,I)%MOOD_O=1
   ELSE
   U_C(I)%VAL(1,1:NOF_VARIABLES)=U_C(I)%VAL(4,1:NOF_VARIABLES)
   END IF
END DO
!$OMP END DO

END IF
 

IF (FASTEST.EQ.1)THEN
    CALL EXCHANGE_LOWER(N)
    CALL ARBITRARY_ORDER2(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI2D(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2d(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2d(N)
    CALL CALCULATE_FLUXESHI_dIFfusive2d(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION2d(N)
    END IF
    END SELECT
ELSE
    CALL EXCHANGE_HIGHER(N)
    CALL ARBITRARY_ORDER2(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI2D(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2d(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2d(N)
    CALL CALCULATE_FLUXESHI_dIFfusive2d(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION2d(N)
    END IF
    CALL VORTEXCALC2D(N)
    END SELECT
END IF
!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
   IF (MOOD.EQ.1)THEN
  U_C(I)%VAL(3,1:NOF_VARIABLES)=U_C(I)%VAL(1,1:NOF_VARIABLES)
  END IF
  U_C(I)%VAL(INDS,1:NOF_VARIABLES)=((OO3)*U_C(I)%VAL(2,1:NOF_VARIABLES))+((TO3)*U_C(I)%VAL(1,1:NOF_VARIABLES))-(((TO3))*&
((DT)*((RHS(I)%VAL(1:NOF_VARIABLES))*(OOVOLUME))))
END DO
!$OMP END DO


IF (MOOD.EQ.1)THEN
 
 CALL MOOD_OPERATOR_2(N)
   !$OMP DO
DO I=1,KMAXE
    IF (IELEM(N,I)%RECALC.EQ.1)THEN
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_C(I)%VAL(INDS,1:NOF_VARIABLES)=((OO3)*U_C(I)%VAL(2,1:NOF_VARIABLES))+((TO3)*U_C(I)%VAL(1,1:NOF_VARIABLES))-(((TO3))*&
((DT)*((RHS(I)%VAL(1:NOF_VARIABLES))*(OOVOLUME))))
   IELEM(N,I)%MOOD_O=2
   END IF
END DO
!$OMP END DO

CALL MOOD_OPERATOR_1(N)

   !$OMP DO
DO I=1,KMAXE
    IF (IELEM(N,I)%RECALC.EQ.1)THEN
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_C(I)%VAL(1,1:NOF_VARIABLES)=((OO3)*U_C(I)%VAL(2,1:NOF_VARIABLES))+((TO3)*U_C(I)%VAL(1,1:NOF_VARIABLES))-(((TO3))*&
((DT)*((RHS(I)%VAL(1:NOF_VARIABLES))*(OOVOLUME))))
    IELEM(N,I)%MOOD_O=1
   ELSE
   U_C(I)%VAL(1,1:NOF_VARIABLES)=U_C(I)%VAL(4,1:NOF_VARIABLES)
   END IF
END DO
!$OMP END DO

END IF


IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)=((OO3)*U_Ct(I)%VAL(2,1:turbulenceequations+passivescalar))+((TO3)*U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar))-(((TO3))*&
((DT)*((RHSt(I)%VAL(1:turbulenceequations+passivescalar))*(OOVOLUME))))
END DO
!$OMP END DO
 END IF



IF (AVERAGING.EQ.1)THEN

 CALL AVERAGING_T(N)
 
END IF

END SUBROUTINE RUNGE_KUTTA3_2D_MOOD



SUBROUTINE RUNGE_KUTTA4(N)
!> @brief
!> SSP RUNGE KUTTA 4TH-ORDER SCHEME
IMPLICIT NONE
INTEGER,INTENT(IN)::N
INTEGER::I,KMAXE
REAL::AVRGS,OOVOLUME,TO4,OO4,TO3,OO3
real::prace_t1,prace_t2,prace_t3,prace_t4,prace_t5,prace_t6,prace_t7,prace_t8,prace_t9,pr_t1,pr_t2,pr_t3,pr_t4,PR_T5,PR_T6,PR_T7,PR_T8
REAL::DUMPRACEIN,DUMPRACEOUT,flops_count
KMAXE=XMPIELRANK(N)
TO4=3.0D0/4.0D0
OO4=1.0D0/4.0D0
TO3=2.0D0/3.0D0
OO3=1.0D0/3.0D0	

IF (FASTEST.EQ.1)THEN

    CALL EXCHANGE_LOWER(N)
    CALL ARBITRARY_ORDER3(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CALL CALCULATE_FLUXESHI_DIFFUSIVE(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION(N)
    END IF
    END SELECT
ELSE
    IF (statistics.eq.1)THEN
    !$OMP BARRIER 
    !$OMP MASTER
    pr_T1=MPI_Wtime()
     !$OMP END MASTER
     !$OMP BARRIER
    END IF
    
     
    CALL EXCHANGE_HIGHER(N)
    IF (statistics.eq.1)THEN
    !$OMP BARRIER 
    !$OMP MASTER
    pr_t2=MPI_Wtime()
    prace_t1=pr_t2-pr_t1
    !$OMP END MASTER
     !$OMP BARRIER
    END IF
    
    CALL ARBITRARY_ORDER3(N)
    IF (statistics.eq.1)THEN
    !$OMP BARRIER 
    !$OMP MASTER
    pr_t3=MPI_Wtime()
    prace_t2=pr_t3-pr_t2
    !$OMP END MASTER
     !$OMP BARRIER
    END IF
    
    
    
    CALL EXHBOUNDHIGHER(N)
    IF (statistics.eq.1)THEN
    !$OMP BARRIER 
    !$OMP MASTER
    pr_t4=MPI_Wtime()
    prace_t3=pr_t4-pr_t3
    !$OMP END MASTER
     !$OMP BARRIER
    END IF
    
    
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CALL CALCULATE_FLUXESHI_DIFFUSIVE(N)
     IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION(N)
    END IF
    END SELECT
    
    
    IF (statistics.eq.1)THEN
    !$OMP BARRIER 
    !$OMP MASTER
    pr_t5=MPI_Wtime()
    prace_t4=pr_t5-pr_t4
    !$OMP END MASTER
     !$OMP BARRIER
    END IF
    
    
    
END IF



!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_C(I)%VAL(2,1:NOF_VARIABLES)=U_C(I)%VAL(1,1:NOF_VARIABLES)
  U_C(I)%VAL(1,1:NOF_VARIABLES)=U_C(I)%VAL(2,1:NOF_VARIABLES)-(DT*0.391752226571890*(RHS(I)%VAL(1:NOF_VARIABLES)*OOVOLUME))
  
END DO
!$OMP END DO

IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_Ct(I)%VAL(2,1:turbulenceequations+passivescalar)=U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)
  U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)=U_Ct(I)%VAL(2,1:turbulenceequations+passivescalar)-(DT*0.391752226571890*(RHSt(I)%VAL(1:turbulenceequations+passivescalar)*OOVOLUME))
  END DO
!$OMP END DO
 END IF
 
 
    IF (statistics.eq.1)THEN
    !$OMP BARRIER 
    !$OMP MASTER
    pr_t6=MPI_Wtime()
    prace_t5=pr_t6-pr_t5
    
    !RECONSTRUCTION TIME=prace_t2
    !COMMUNICATION TIME OF EXBOUNDHIGHER=prace_t3
    !COMMUNICATION TIME OF HALO CELLS=prace_t1
    !FLUXES=prace_t4
    !UPDATE OF SOLUTION=prace_t5
    !TOTAL COMMUNICATION TIME=PRACE_T1+PRACE_T3=PRACE_T6
    !TOTAL COMPUTATIONALS TIME=PRACE_T2+PRACE_T4+PRACE_T5=PRACE_T7
    !TOTAL TIME=TOTAL COMMUNICATION TIME+TOTAL COMPUTATIONALS TIME=PRACE_T8
   PRACE_T6=PRACE_T1+PRACE_T3
   PRACE_T7=PRACE_T2+PRACE_T4+PRACE_T5
   PRACE_T8=PRACE_T7+PRACE_T6
   
   DUMPRACEIN=PRACE_t1
 CALL MPI_ALLREDUCE(DUMPRACEIN,DUMPRACEOUT,1,MPI_DOUBLE_PRECISION,MPI_MAX,MPI_COMM_WORLD,IERROR)
   PRACE_t1=DUMPRACEOUT
   DUMPRACEIN=PRACE_t2
 CALL MPI_ALLREDUCE(DUMPRACEIN,DUMPRACEOUT,1,MPI_DOUBLE_PRECISION,MPI_MAX,MPI_COMM_WORLD,IERROR)
   PRACE_t2=DUMPRACEOUT
   DUMPRACEIN=PRACE_t3
 CALL MPI_ALLREDUCE(DUMPRACEIN,DUMPRACEOUT,1,MPI_DOUBLE_PRECISION,MPI_MAX,MPI_COMM_WORLD,IERROR)
   PRACE_t3=DUMPRACEOUT
   DUMPRACEIN=PRACE_t4
 CALL MPI_ALLREDUCE(DUMPRACEIN,DUMPRACEOUT,1,MPI_DOUBLE_PRECISION,MPI_MAX,MPI_COMM_WORLD,IERROR)
   PRACE_t4=DUMPRACEOUT
   DUMPRACEIN=PRACE_t5
 CALL MPI_ALLREDUCE(DUMPRACEIN,DUMPRACEOUT,1,MPI_DOUBLE_PRECISION,MPI_MAX,MPI_COMM_WORLD,IERROR)
   PRACE_t5=DUMPRACEOUT
!    DUMPRACEIN=PRACE_t6
!  CALL MPI_ALLREDUCE(DUMPRACEIN,DUMPRACEOUT,1,MPI_DOUBLE_PRECISION,MPI_MAX,MPI_COMM_WORLD,IERROR)
!    PRACE_t6=DUMPRACEOUT
!    DUMPRACEIN=PRACE_t7
!  CALL MPI_ALLREDUCE(DUMPRACEIN,DUMPRACEOUT,1,MPI_DOUBLE_PRECISION,MPI_MAX,MPI_COMM_WORLD,IERROR)
!    PRACE_t7=DUMPRACEOUT
!    DUMPRACEIN=PRACE_t8
!  CALL MPI_ALLREDUCE(DUMPRACEIN,DUMPRACEOUT,1,MPI_DOUBLE_PRECISION,MPI_MAX,MPI_COMM_WORLD,IERROR)
!    PRACE_t8=DUMPRACEOUT
    PRACE_T6=PRACE_T1+PRACE_T3
   PRACE_T7=PRACE_T2+PRACE_T4+PRACE_T5
   PRACE_T8=PRACE_T7+PRACE_T6

   FLOPS_COUNT=(((2*idegfree*nof_Variables*(imaxdegfree+1)*5)+(2*nof_Variables*nof_variables*idegfree*4)+(2*idegfree*nof_Variables*nof_variables*5)+(2*idegfree*nof_Variables*idegfree*5)+&
                (QP_QUAD*2*6*3*3*3)+(QP_QUAD*3*2*5*6*5*5)+(5*5*5*2*QP_QUAD*6)+(QP_QUAD*nof_Variables*6*2)+(QP_QUAD*2*6)+(idegfree*QP_QUAD*6*iorder)+(20+300*IORDER*QP_QUAD*6+200+12000*QP_QUAD*6*2))/prace_t8)*1e-9*imaxe


   
    IF (N.EQ.0)THEN
    OPEN(133,FILE=STATFILE,FORM='FORMATTED',STATUS='old',ACTION='WRITE',POSITION='APPEND')
    WRITE(133,'(I6,1X,E11.4,E11.4,E11.4,E11.4,E11.4,E11.4,E11.4,E11.4,E11.4)')it,PRACE_T8,PRACE_T6,PRACE_T1,PRACE_T3,PRACE_T7,prace_t2,prace_t4,prace_t5,flops_count
    CLOSE(133)
    END IF
    
    
    !$OMP END MASTER
     !$OMP BARRIER
    
    END IF


IF (FASTEST.EQ.1)THEN
    CALL EXCHANGE_LOWER(N)
    CALL ARBITRARY_ORDER3(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CALL CALCULATE_FLUXESHI_DIFFUSIVE(N)
     IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION(N)
    END IF
    END SELECT
ELSE
    CALL EXCHANGE_HIGHER(N)
    CALL ARBITRARY_ORDER3(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CALL CALCULATE_FLUXESHI_DIFFUSIVE(N)
     IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION(N)
    END IF
    END SELECT
END IF

!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_C(I)%VAL(3,1:NOF_VARIABLES)=U_C(I)%VAL(1,1:NOF_VARIABLES)
  U_C(I)%VAL(1,1:NOF_VARIABLES)=(0.444370493651235*U_C(I)%VAL(2,1:NOF_VARIABLES))+(0.555629506348765*U_C(I)%VAL(3,1:NOF_VARIABLES))-(((0.368410593050371))*((DT)*&
((RHS(I)%VAL(1:NOF_VARIABLES))*(OOVOLUME))))
END DO
!$OMP END DO

IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
    U_Ct(I)%VAL(3,1:turbulenceequations+passivescalar)=U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)
  U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)=(0.444370493651235*U_Ct(I)%VAL(2,1:turbulenceequations+passivescalar))+(0.555629506348765*U_Ct(I)%VAL(3,1:turbulenceequations+passivescalar))-(((0.368410593050371))*((DT)*&
((RHSt(I)%VAL(1:turbulenceequations+passivescalar))*(OOVOLUME))))
END DO
!$OMP END DO
 END IF




IF (FASTEST.EQ.1)THEN
    CALL EXCHANGE_LOWER(N)
    CALL ARBITRARY_ORDER3(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CALL CALCULATE_FLUXESHI_DIFFUSIVE(N)
     IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION(N)
    END IF
    END SELECT
ELSE
    CALL EXCHANGE_HIGHER(N)
    CALL ARBITRARY_ORDER3(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CALL CALCULATE_FLUXESHI_DIFFUSIVE(N)
     IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION(N)
    END IF
    END SELECT
END IF
!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_C(I)%VAL(4,1:NOF_VARIABLES)=U_C(I)%VAL(1,1:NOF_VARIABLES)
  U_C(I)%VAL(1,1:NOF_VARIABLES)=(0.620101851488403*U_C(I)%VAL(2,1:NOF_VARIABLES))+(0.379898148511597*U_C(I)%VAL(4,1:NOF_VARIABLES))-(((0.251891774271694))*((DT)*&
((RHS(I)%VAL(1:NOF_VARIABLES))*(OOVOLUME))))
END DO
!$OMP END DO


IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_Ct(I)%VAL(4,1:turbulenceequations+passivescalar)=U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)
  U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)=(0.620101851488403*U_Ct(I)%VAL(2,1:turbulenceequations+passivescalar))+(0.379898148511597*U_Ct(I)%VAL(4,1:turbulenceequations+passivescalar))-(((0.251891774271694))*((DT)*&
((RHSt(I)%VAL(1:turbulenceequations+passivescalar))*(OOVOLUME))))
END DO
!$OMP END DO
 END IF


IF (FASTEST.EQ.1)THEN
    CALL EXCHANGE_LOWER(N)
    CALL ARBITRARY_ORDER3(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CALL CALCULATE_FLUXESHI_DIFFUSIVE(N)
     IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION(N)
    END IF
    END SELECT
ELSE
    CALL EXCHANGE_HIGHER(N)
    CALL ARBITRARY_ORDER3(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CALL CALCULATE_FLUXESHI_DIFFUSIVE(N)
     IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION(N)
    END IF
    END SELECT
END IF
!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_C(I)%VAL(5,1:NOF_VARIABLES)=U_C(I)%VAL(1,1:NOF_VARIABLES)
  U_C(I)%VAL(6,1:NOF_VARIABLES)=-((DT)*((RHS(I)%VAL(1:NOF_VARIABLES))*(OOVOLUME)))
  U_C(I)%VAL(1,1:NOF_VARIABLES)=(0.178079954393132*U_C(I)%VAL(2,1:NOF_VARIABLES))+(0.821920045606868*U_C(I)%VAL(5,1:NOF_VARIABLES))-(((0.544974750228521))*((DT)*&
((RHS(I)%VAL(1:NOF_VARIABLES))*(OOVOLUME))))
END DO
!$OMP END DO

IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
    U_Ct(I)%VAL(5,1:turbulenceequations+passivescalar)=U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)
  U_Ct(I)%VAL(6,1:turbulenceequations+passivescalar)=-((DT)*((RHSt(I)%VAL(1:turbulenceequations+passivescalar))*(OOVOLUME)))
  U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)=(0.178079954393132*U_Ct(I)%VAL(2,1:turbulenceequations+passivescalar))+(0.821920045606868*U_Ct(I)%VAL(5,1:turbulenceequations+passivescalar))-(((0.544974750228521))*((DT)*&
((RHSt(I)%VAL(1:turbulenceequations+passivescalar))*(OOVOLUME))))
END DO
!$OMP END DO
 END IF



IF (FASTEST.EQ.1)THEN
    CALL EXCHANGE_LOWER(N)
    CALL ARBITRARY_ORDER3(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CALL CALCULATE_FLUXESHI_DIFFUSIVE(N)
     IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION(N)
    END IF
    END SELECT
ELSE
    CALL EXCHANGE_HIGHER(N)
    CALL ARBITRARY_ORDER3(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CALL CALCULATE_FLUXESHI_DIFFUSIVE(N)
     IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION(N)
    END IF
    CALL VORTEXCALC(N)
    END SELECT
END IF
!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_C(I)%VAL(1,1:NOF_VARIABLES)=(0.00683325884039*U_C(I)%VAL(2,1:NOF_VARIABLES))+(0.517231671970585*U_C(I)%VAL(4,1:NOF_VARIABLES))+&
				(0.12759831133288*U_C(I)%VAL(5,1:NOF_VARIABLES))+(0.34833675773694*U_C(I)%VAL(1,1:NOF_VARIABLES))+&
				(0.08460416338212*U_C(I)%VAL(6,1:NOF_VARIABLES))-(0.22600748319395*(DT)*((RHS(I)%VAL(1:NOF_VARIABLES))*(OOVOLUME)))
END DO
!$OMP END DO


IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
   U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)=(0.00683325884039*U_Ct(I)%VAL(2,1:turbulenceequations+passivescalar))+(0.517231671970585*U_Ct(I)%VAL(4,1:turbulenceequations+passivescalar))+&
				(0.12759831133288*U_Ct(I)%VAL(5,1:turbulenceequations+passivescalar))+(0.34833675773694*U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar))+&
				(0.08460416338212*U_Ct(I)%VAL(6,1:turbulenceequations+passivescalar))-(0.22600748319395*(DT)*((RHSt(I)%VAL(1:turbulenceequations+passivescalar))*(OOVOLUME)))
END DO
!$OMP END DO
 END IF


IF (AVERAGING.EQ.1)THEN

 CALL AVERAGING_T(N)
 
END IF


END SUBROUTINE RUNGE_KUTTA4

SUBROUTINE CALL_FLUX_SUBROUTINES_2D
    IF (FASTEST.EQ.1) THEN
        CALL EXCHANGE_LOWER(N)
    ELSE
        CALL EXCHANGE_HIGHER(N)
    END IF
        
    IF (DG == 1) THEN
        CALL RECONSTRUCT_DG(N)
    ELSE
        CALL ARBITRARY_ORDER2(N)
    END IF
    
    CALL EXHBOUNDHIGHER(N)
    
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI2D(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2d(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2d(N)
    CALL CALCULATE_FLUXESHI_dIFfusive2d(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION2d(N)
    END IF
    END SELECT
        
END SUBROUTINE CALL_FLUX_SUBROUTINES_2D

SUBROUTINE RUNGE_KUTTA4_2D(N)
!> @brief
!> SSP RUNGE KUTTA 4TH-ORDER SCHEME IN 2D
IMPLICIT NONE
INTEGER,INTENT(IN)::N
INTEGER::I,KMAXE,RK_STAGE
REAL::AVRGS,OOVOLUME,TO4,OO4,TO3,OO3
KMAXE=XMPIELRANK(N)
TO4=3.0D0/4.0D0
OO4=1.0D0/4.0D0
TO3=2.0D0/3.0D0
OO3=1.0D0/3.0D0
RK_STAGE = 0

CALL CALL_FLUX_SUBROUTINES_2D

!$OMP DO
DO I=1,KMAXE
    OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME

    IF (DG == 1) THEN
        U_C(I)%VALDG(2,:,:)=U_C(I)%VALDG(1,:,:)
        U_C(I)%VALDG(1,:,:)=U_C(I)%VALDG(2,:,:) - DT * 0.391752226571890 * TRANSPOSE(MATMUL(INV_MASS_MATRIX(N,I,:,:), RHS(I)%VALDG(:,:)))!*OOVOLUME
    ELSE
        U_C(I)%VAL(2,1:NOF_VARIABLES)=U_C(I)%VAL(1,1:NOF_VARIABLES)
        U_C(I)%VAL(1,1:NOF_VARIABLES)=U_C(I)%VAL(2,1:NOF_VARIABLES)-(DT*0.391752226571890*(RHS(I)%VAL(1:NOF_VARIABLES)*OOVOLUME))
    END IF
END DO
!$OMP END DO
! WRITE(500+N,*) SHAPE(U_C(1)%VALDG(2,:,:)), SHAPE(MATMUL(INV_MASS_MATRIX(N,1,:,:), RHS(1)%VALDG(:,:))), DT * 0.391752226571890 * MATMUL(INV_MASS_MATRIX(N,1,:,:), RHS(1)%VALDG(:,:))
WRITE(500+N,*) 'RK_STAGE', RK_STAGE, U_C(1)%VALDG(1,:,:)
RK_STAGE = RK_STAGE + 1

IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_Ct(I)%VAL(2,1:turbulenceequations+passivescalar)=U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)
  U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)=U_Ct(I)%VAL(2,1:turbulenceequations+passivescalar)-(DT*0.391752226571890*(RHSt(I)%VAL(1:turbulenceequations+passivescalar)*OOVOLUME))
  END DO
!$OMP END DO
 END IF

CALL CALL_FLUX_SUBROUTINES_2D

!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  
    IF (DG == 1) THEN
        U_C(I)%VALDG(3,:,:) = U_C(I)%VALDG(1,:,:)
        U_C(I)%VALDG(1,:,:) = 0.444370493651235 * U_C(I)%VALDG(2,:,:) + 0.555629506348765 * U_C(I)%VALDG(3,:,:) - 0.368410593050371 * DT * TRANSPOSE(MATMUL(INV_MASS_MATRIX(N,I,:,:), RHS(I)%VALDG(:,:)))! * OOVOLUME
    ELSE
        U_C(I)%VAL(3,1:NOF_VARIABLES)=U_C(I)%VAL(1,1:NOF_VARIABLES)
        U_C(I)%VAL(1,1:NOF_VARIABLES)=(0.444370493651235 * U_C(I)%VAL(2,1:NOF_VARIABLES)) + (0.555629506348765 * U_C(I)%VAL(3,1:NOF_VARIABLES)) - 0.368410593050371 * DT * RHS(I)%VAL(1:NOF_VARIABLES) * OOVOLUME
    END IF
END DO
!$OMP END DO
WRITE(500+N,*) 'RK_STAGE', RK_STAGE, U_C(1)%VALDG(1,:,:)
RK_STAGE = RK_STAGE + 1

IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
    U_Ct(I)%VAL(3,1:turbulenceequations+passivescalar)=U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)
  U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)=(0.444370493651235*U_Ct(I)%VAL(2,1:turbulenceequations+passivescalar))+(0.555629506348765*U_Ct(I)%VAL(3,1:turbulenceequations+passivescalar))-(((0.368410593050371))*((DT)*&
((RHSt(I)%VAL(1:turbulenceequations+passivescalar))*(OOVOLUME))))
END DO
!$OMP END DO
 END IF

CALL CALL_FLUX_SUBROUTINES_2D

!$OMP DO
DO I=1,KMAXE
    OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
    
    IF (DG == 1) THEN
        U_C(I)%VALDG(4,:,:) = U_C(I)%VALDG(1,:,:)
        U_C(I)%VALDG(1,:,:) = 0.620101851488403 * U_C(I)%VALDG(2,:,:) + 0.379898148511597 * U_C(I)%VALDG(4,:,:) - 0.251891774271694 * DT * TRANSPOSE(MATMUL(INV_MASS_MATRIX(N,I,:,:), RHS(I)%VALDG(:,:)))! * OOVOLUME
    ELSE
        U_C(I)%VAL(4,1:NOF_VARIABLES) = U_C(I)%VAL(1,1:NOF_VARIABLES)
        U_C(I)%VAL(1,1:NOF_VARIABLES) = 0.620101851488403 * U_C(I)%VAL(2,1:NOF_VARIABLES) + 0.379898148511597 * U_C(I)%VAL(4,1:NOF_VARIABLES) - 0.251891774271694 * DT * RHS(I)%VAL(1:NOF_VARIABLES) * OOVOLUME
    END IF
END DO
!$OMP END DO
WRITE(500+N,*) 'RK_STAGE', RK_STAGE, U_C(1)%VALDG(1,:,:)
RK_STAGE = RK_STAGE + 1

IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
  U_Ct(I)%VAL(4,1:turbulenceequations+passivescalar)=U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)
  U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)=(0.620101851488403*U_Ct(I)%VAL(2,1:turbulenceequations+passivescalar))+(0.379898148511597*U_Ct(I)%VAL(4,1:turbulenceequations+passivescalar))-(((0.251891774271694))*((DT)*&
((RHSt(I)%VAL(1:turbulenceequations+passivescalar))*(OOVOLUME))))
END DO
!$OMP END DO
 END IF
 
CALL CALL_FLUX_SUBROUTINES_2D

!$OMP DO
DO I=1,KMAXE
    OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
    
    IF (DG == 1) THEN
        U_C(I)%VALDG(5,:,:) = U_C(I)%VALDG(1,:,:)
        U_C(I)%VALDG(6,:,:) = - DT * TRANSPOSE(MATMUL(INV_MASS_MATRIX(N,I,:,:), RHS(I)%VALDG(:,:)))! * OOVOLUME
        U_C(I)%VALDG(1,:,:) = 0.178079954393132 * U_C(I)%VALDG(2,:,:) + 0.821920045606868 * U_C(I)%VALDG(5,:,:) + 0.544974750228521 * DT * U_C(I)%VALDG(6,:,:)
    ELSE
        U_C(I)%VAL(5,1:NOF_VARIABLES) = U_C(I)%VAL(1,1:NOF_VARIABLES)
        U_C(I)%VAL(6,1:NOF_VARIABLES) = - DT * RHS(I)%VAL(1:NOF_VARIABLES) * OOVOLUME
        U_C(I)%VAL(1,1:NOF_VARIABLES) = 0.178079954393132 * U_C(I)%VAL(2,1:NOF_VARIABLES) + 0.821920045606868 * U_C(I)%VAL(5,1:NOF_VARIABLES) - 0.544974750228521 * DT * RHS(I)%VAL(1:NOF_VARIABLES) * OOVOLUME
    END IF
END DO
!$OMP END DO
WRITE(500+N,*) 'RK_STAGE', RK_STAGE, U_C(1)%VALDG(1,:,:)
RK_STAGE = RK_STAGE + 1

IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
    U_Ct(I)%VAL(5,1:turbulenceequations+passivescalar)=U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)
  U_Ct(I)%VAL(6,1:turbulenceequations+passivescalar)=-((DT)*((RHSt(I)%VAL(1:turbulenceequations+passivescalar))*(OOVOLUME)))
  U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)=(0.178079954393132*U_Ct(I)%VAL(2,1:turbulenceequations+passivescalar))+(0.821920045606868*U_Ct(I)%VAL(5,1:turbulenceequations+passivescalar))-(((0.544974750228521))*((DT)*&
((RHSt(I)%VAL(1:turbulenceequations+passivescalar))*(OOVOLUME))))
END DO
!$OMP END DO
END IF

CALL CALL_FLUX_SUBROUTINES_2D
IF (FASTEST /= 1)THEN
    IF (ITESTCASE.EQ.4)THEN
        CALL VORTEXCALC2D(N)
    END IF
END IF

!$OMP DO
DO I=1,KMAXE
    OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
    
    IF (DG == 1) THEN
        U_C(I)%VALDG(1,1:NOF_VARIABLES,:) = (0.00683325884039 * U_C(I)%VALDG(2,1:NOF_VARIABLES,:)) + (0.517231671970585 * U_C(I)%VALDG(4,1:NOF_VARIABLES,:)) + (0.12759831133288 * U_C(I)%VALDG(5,1:NOF_VARIABLES,:)) + (0.34833675773694 * U_C(I)%VALDG(1,1:NOF_VARIABLES,:)) + (0.08460416338212 * U_C(I)%VALDG(6,1:NOF_VARIABLES,:)) - 0.22600748319395 * DT * TRANSPOSE(MATMUL(INV_MASS_MATRIX(N,I,:,:), RHS(I)%VALDG(:,:)))! * OOVOLUME
    ELSE
        U_C(I)%VAL(1,1:NOF_VARIABLES) = (0.00683325884039 * U_C(I)%VAL(2,1:NOF_VARIABLES)) + (0.517231671970585 * U_C(I)%VAL(4,1:NOF_VARIABLES)) +  (0.12759831133288 * U_C(I)%VAL(5,1:NOF_VARIABLES)) + (0.34833675773694 * U_C(I)%VAL(1,1:NOF_VARIABLES)) + (0.08460416338212 * U_C(I)%VAL(6,1:NOF_VARIABLES)) - (0.22600748319395 * DT * RHS(I)%VAL(1:NOF_VARIABLES) * OOVOLUME)
    END IF
END DO
!$OMP END DO
WRITE(500+N,*) RK_STAGE, U_C(1)%VALDG(1,:,:)
RK_STAGE = RK_STAGE + 1

IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
!$OMP DO
DO I=1,KMAXE
  OOVOLUME=1.0D0/IELEM(N,I)%TOTVOLUME
   U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar)=(0.00683325884039*U_Ct(I)%VAL(2,1:turbulenceequations+passivescalar))+(0.517231671970585*U_Ct(I)%VAL(4,1:turbulenceequations+passivescalar))+&
				(0.12759831133288*U_Ct(I)%VAL(5,1:turbulenceequations+passivescalar))+(0.34833675773694*U_Ct(I)%VAL(1,1:turbulenceequations+passivescalar))+&
				(0.08460416338212*U_Ct(I)%VAL(6,1:turbulenceequations+passivescalar))-(0.22600748319395*(DT)*((RHSt(I)%VAL(1:turbulenceequations+passivescalar))*(OOVOLUME)))
END DO
!$OMP END DO
 END IF

IF (AVERAGING.EQ.1)THEN

 CALL AVERAGING_T(N)
 
END IF

IF (DG == 1 .AND. ALL(U_C(1)%VALDG(1,:,:) /= U_C(1)%VALDG(1,:,:))) THEN
    IF (N == 0) PRINT*, 'STOPPING BECAUSE NaNs'
    STOP ! Stop if NaNs
END IF

END SUBROUTINE RUNGE_KUTTA4_2D




SUBROUTINE IMPLICIT_TIMEs(N)
!> @brief
!> IMPLICIT APPROXIMATELY FACTORED TIME STEPPING SCHEME
IMPLICIT NONE
INTEGER::I,K,KMAXE,kill_nan
INTEGER,INTENT(IN)::N
reaL::verysmall
verysmall = tolsmall


KMAXE=XMPIELRANK(N)
IF (FASTEST.EQ.1)THEN
    CALL EXCHANGE_LOWER(N)
    CALL ARBITRARY_ORDER3(N)
    CALL EXHBOUNDHIGHER(N)
    
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CALL CALCULATE_FLUXESHI_dIFfusive(N)
    CALL VORTEXCALC(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION(N)
    END IF
    END SELECT
    
ELSE
    CALL EXCHANGE_HIGHER(N)
    CALL ARBITRARY_ORDER3(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CALL CALCULATE_FLUXESHI_dIFfusive(N)
    CALL VORTEXCALC(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION(N)
    END IF
    END SELECT
END IF

IF (RELAX.EQ.3)THEN
 
 CALL RELAXATION_LUMFREE(N)
 
 ELSE
  
IF (lowmemory.eq.0)THEN
   
 CALL RELAXATION(N)
   
 ELSE
 
 CALL RELAXATION_lm(N)
 
 END IF
   
  END IF

 kill_nan=0
 
!$OMP DO
DO I=1,KMAXE
    IF ((impdu(i,1).ne.impdu(i,1)).or.(impdu(i,2).ne.impdu(i,2)).or.(impdu(i,3).ne.impdu(i,3)).or.(impdu(i,4).ne.impdu(i,4)).or.(impdu(i,5).ne.impdu(i,5)))THEN
        write(600+n,*)"nan present",ielem(n,i)%ihexgl,ielem(n,i)%ishape,ielem(n,i)%xxc, ielem(n,i)%yyc,ielem(n,i)%zzc
        write(600+n,*)ielem(n,i)%dih(:)
        kill_nan=1
    END IF
  U_C(I)%VAL(1,1:nof_Variables)=U_C(I)%VAL(1,1:nof_Variables)+IMPDU(I,1:nof_Variables)
END DO
!$OMP END DO
    IF (kill_nan.eq.1)THEN
        stop
    END IF

IF ((PASSIVESCALAR.GT.0).OR.(TURBULENCE.GT.0))THEN
!$OMP DO
  DO I=1,KMAXE
  do k=1,turbulenceequations+passivescalar
  IF (U_CT(I)%VAL(1,k)+IMPDU(I,5+k).ge.zero)THEN
  U_CT(I)%VAL(1,k)=U_CT(I)%VAL(1,k)+0.4*IMPDU(i,5+k)
  END IF
  END do
END DO
!$OMP END DO
END IF









  
END SUBROUTINE IMPLICIT_TIMEs


SUBROUTINE IMPLICIT_TIMEs_2d(N) 
!> @brief
!> IMPLICIT APPROXIMATELY FACTORED TIME STEPPING SCHEME 2D
IMPLICIT NONE
INTEGER::I,K,KMAXE,kill_nan
INTEGER,INTENT(IN)::N
reaL::verysmall
verysmall = tolsmall


KMAXE=XMPIELRANK(N)
IF (FASTEST.EQ.1)THEN
    CALL EXCHANGE_LOWER(N)
    CALL ARBITRARY_ORDER2(N)
    CALL EXHBOUNDHIGHER(N)
    
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI2d(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2d(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2d(N)
    CALL CALCULATE_FLUXESHI_dIFfusive2d(N)
   ! CALL VORTEXCALC2D(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION2d(N)
    END IF
    END SELECT
    
ELSE
    CALL EXCHANGE_HIGHER(N)
    CALL ARBITRARY_ORDER2(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI2d(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2d(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2d(N)
    CALL CALCULATE_FLUXESHI_dIFfusive2d(N)
    !CALL VORTEXCALC2D(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION2d(N)
    END IF
    END SELECT
END IF



 IF (RELAX.EQ.3)THEN
 
 CALL RELAXATION_LUMFREE(N)
 
 ELSE
 IF (lowmemory.eq.0)THEN
   
 CALL RELAXATION2d(N)
   
 ELSE
 
 CALL RELAXATION_lm2d(N)
 
 END IF
  END IF

 kill_nan=0
!$OMP DO
DO I=1,KMAXE

    IF ((impdu(i,1).ne.impdu(i,1)).or.(impdu(i,2).ne.impdu(i,2)).or.(impdu(i,3).ne.impdu(i,3)).or.(impdu(i,4).ne.impdu(i,4)))THEN
        write(600+n,*)"nan present",ielem(n,i)%ihexgl,ielem(n,i)%ishape,ielem(n,i)%xxc, ielem(n,i)%yyc
        write(600+n,*)ielem(n,i)%dih(:)
        kill_nan=1
    END IF

    
    
    

  U_C(I)%VAL(1,1:nof_Variables)=U_C(I)%VAL(1,1:nof_Variables)+IMPDU(I,1:nof_Variables)
END DO
!$OMP END DO

    IF (kill_nan.eq.1)THEN
        stop
    END IF



IF ((PASSIVESCALAR.GT.0).OR.(TURBULENCE.GT.0))THEN
!$OMP DO
  DO I=1,KMAXE
  do k=1,turbulenceequations+passivescalar
  IF (ispal.eq.1)THEN
  IF (U_CT(I)%VAL(1,k)+IMPDU(I,4+k).ge.zero)THEN
  U_CT(I)%VAL(1,k)=U_CT(I)%VAL(1,k)+0.4*IMPDU(i,4+k)
   END IF
   ELSE
   U_CT(I)%VAL(1,k)=U_CT(I)%VAL(1,k)+0.4*IMPDU(i,4+k)
   
   END IF
  END do
END DO
!$OMP END DO

!   IF (kill_nan.eq.2)THEN
!         stop
!     END IF



END IF









  
END SUBROUTINE IMPLICIT_TIMEs_2d


SUBROUTINE DUAL_TIME(N)
!> @brief
!> DUAL TIME STEPPING
IMPLICIT NONE
INTEGER::I,K,KMAXE,jj,kill_nan
INTEGER,INTENT(IN)::N
reaL::verysmall
real::firsti,resmaxi,rsumfacei,suml2ri,dummy3i,inner_tol
verysmall = tolsmall

inner_tol=reslimit

KMAXE=XMPIELRANK(N)


IF (IT.EQ.RESTART)THEN
!$OMP DO
DO I=1,KMAXE 
  U_C(I)%VAL(3,1:NOF_VARIABLES)=U_C(I)%VAL(1,1:NOF_VARIABLES)
  U_C(I)%VAL(2,1:nof_variables)=U_C(I)%VAL(1,1:nof_variables)
  IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
  U_CT(I)%VAL(3,:)=U_CT(I)%VAL(1,:)
  U_CT(I)%VAL(2,:)=U_CT(I)%VAL(1,:)
  END IF
END DO
!$OMP END DO
END IF





firsti=0.0d0
DO JJ=1,upperlimit
      rsumfacei=zero;allresdt=zero;dummy3i=zero; 
   if (jj.eq.1)then
    iscoun=1
      else
      iscoun=2
      end if    
    
      

      
IF (FASTEST.EQ.1)THEN
    CALL EXCHANGE_LOWER(N)
    CALL ARBITRARY_ORDER3(N)
    CALL EXHBOUNDHIGHER(N)
    
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CALL CALCULATE_FLUXESHI_dIFfusive(N)
    CALL VORTEXCALC(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION(N)
    END IF
    END SELECT
    
ELSE
    CALL EXCHANGE_HIGHER(N)
    CALL ARBITRARY_ORDER3(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CALL CALCULATE_FLUXESHI_dIFfusive(N)
    CALL VORTEXCALC(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION(N)
    END IF
    END SELECT
END IF


IF (relax.eq.3)THEN



CALL RELAXATION_LUMFREE(N)


ELSE


IF (lowmemory.eq.0)THEN
   
 CALL RELAXATION(N)
   
 ELSE
 
 CALL RELAXATION_lm(N)
 
 END IF
 END IF

 
 kill_nan=0
 
!$OMP BARRIER 
!$OMP DO SCHEDULE(STATIC) REDUCTION(+:allresdt)
DO I=1,KMAXE
      rsumfacei=sqrt(((IMPDU(I,1))**2)+((IMPDU(I,2))**2)+((IMPDU(I,3))**2)+((IMPDU(I,4))**2)+((IMPDU(I,5))**2))
      allresdt=allresdt+(rsumfacei*ielem(n,i)%totvolume)
      
      IF ((impdu(i,1).ne.impdu(i,1)).or.(impdu(i,2).ne.impdu(i,2)).or.(impdu(i,3).ne.impdu(i,3)).or.(impdu(i,4).ne.impdu(i,4)).or.(impdu(i,5).ne.impdu(i,5)))THEN
      kill_nan=1
      END IF
END do
!$OMP END DO


!$OMP BARRIER 

     IF (kill_nan.eq.1)THEN
        stop
    END IF



!$OMP MASTER
DUMMY3I=zero







CALL MPI_ALLREDUCE(allresdt,DUMMY3i,1,MPI_DOUBLE_PRECISION,MPI_SUM,MPI_COMM_WORLD,IERROR)
allresdt=dummy3i/TOTALVOLUME

IF (allresdt.gt.firsti)THEN
firsti=allresdt
END IF

allresdt=allresdt/firsti


IF (n.eq.0)THEN
				  OPEN(77,FILE='res1.txt',FORM='FORMATTED',ACTION='WRITE',POSITION='APPEND')
				  WRITE(77,*)allresdt,jj,it
				  CLOSE(77)

END IF

!$OMP END MASTER
!$OMP BARRIER 



  IF ((allresdt.le.inner_tol).or.(jj.eq.upperlimit))THEN
 !$OMP DO SCHEDULE (STATIC)
  DO I=1,KMAXE
 U_C(I)%VAL(1,1:nof_Variables)=U_C(I)%VAL(1,1:nof_Variables)+IMPDU(I,1:nof_Variables)
    IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
    do k=1,turbulenceequations+passivescalar
	IF (U_CT(I)%VAL(1,k)+IMPDU(I,nof_Variables+k).ge.zero)THEN
  U_CT(I)%VAL(1,k)=U_CT(I)%VAL(1,k)+IMPDU(i,nof_Variables+k)
	END IF
    END do
    END IF
  END DO
!$OMP END DO
  exit

ELSE
 !$OMP DO SCHEDULE (STATIC)
 DO I=1,KMAXE
 U_C(I)%VAL(1,1:nof_Variables)=U_C(I)%VAL(1,1:nof_Variables)+IMPDU(I,1:nof_Variables)
    IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
    do k=1,turbulenceequations+passivescalar
	IF (U_CT(I)%VAL(1,k)+IMPDU(I,nof_Variables+k).ge.zero)THEN
  U_CT(I)%VAL(1,k)=U_CT(I)%VAL(1,k)+IMPDU(i,nof_Variables+k)
	END IF
    END do
    END IF
  END DO
!$OMP END DO

END IF


END DO

!$OMP DO
DO I=1,KMAXE 
  U_C(I)%VAL(3,1:NOF_VARIABLES)=U_C(I)%VAL(2,1:NOF_VARIABLES)
  U_C(I)%VAL(2,1:nof_variables)=U_C(I)%VAL(1,1:nof_variables)
  !U_C(I)%VAL(1,1:nof_variables)=2.0*U_C(I)%VAL(2,1:nof_variables)-U_C(I)%VAL(3,1:nof_variables)
  
  
  IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
  U_CT(I)%VAL(3,:)=U_CT(I)%VAL(2,:)
  U_CT(I)%VAL(2,:)=U_CT(I)%VAL(1,:)
  !U_CT(I)%VAL(1,:)=2.0*U_CT(I)%VAL(2,:)-U_CT(I)%VAL(3,:)
  end if
END DO
!$OMP END DO

IF (AVERAGING.EQ.1)THEN

 CALL AVERAGING_T(N)
 
END IF










  
END SUBROUTINE dual_time




















SUBROUTINE DUAL_TIME_EX(N)
!> @brief
!> DUAL TIME STEPPING 2D
IMPLICIT NONE
INTEGER::I,K,KMAXE,jj
INTEGER,INTENT(IN)::N
reaL::verysmall
real::firsti,resmaxi,rsumfacei,suml2ri,dummy3i,inner_tol
verysmall = tolsmall

inner_tol=reslimit

KMAXE=XMPIELRANK(N)


IF (IT.EQ.RESTART)THEN
!$OMP DO
DO I=1,KMAXE 
  U_C(I)%VAL(3,1:NOF_VARIABLES)=U_C(I)%VAL(1,1:NOF_VARIABLES)
  U_C(I)%VAL(2,1:nof_variables)=U_C(I)%VAL(1,1:nof_variables)
  IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
  U_CT(I)%VAL(3,:)=U_CT(I)%VAL(1,:)
  U_CT(I)%VAL(2,:)=U_CT(I)%VAL(1,:)
  END IF
END DO
!$OMP END DO
END IF





firsti=0.0d0
DO JJ=1,upperlimit
      rsumfacei=zero;allresdt=zero;dummy3i=zero; 
      
      
      
      
      
      
IF (FASTEST.EQ.1)THEN
    CALL EXCHANGE_LOWER(N)
    CALL ARBITRARY_ORDER3(N)
    CALL EXHBOUNDHIGHER(N)
    
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CALL CALCULATE_FLUXESHI_dIFfusive(N)
    CALL VORTEXCALC(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION(N)
    END IF
    END SELECT
    
ELSE
    CALL EXCHANGE_HIGHER(N)
    CALL ARBITRARY_ORDER3(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE(N)
    CALL CALCULATE_FLUXESHI_dIFfusive(N)
    CALL VORTEXCALC(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION(N)
    END IF
    END SELECT
END IF


CALL RELAXATION_EX(N)





!$OMP BARRIER 
!$OMP DO SCHEDULE(STATIC) REDUCTION(+:allresdt)
DO I=1,KMAXE
      rsumfacei=sqrt(((IMPDU(I,1))**2)+((IMPDU(I,2))**2)+((IMPDU(I,3))**2)+((IMPDU(I,4))**2)+((IMPDU(I,5))**2))
      allresdt=allresdt+(rsumfacei*ielem(n,i)%totvolume)
END do
!$OMP END DO

!$OMP BARRIER 
!$OMP MASTER
DUMMY3I=zero

CALL MPI_ALLREDUCE(allresdt,DUMMY3i,1,MPI_DOUBLE_PRECISION,MPI_SUM,MPI_COMM_WORLD,IERROR)
allresdt=dummy3i/TOTALVOLUME



IF (allresdt.gt.firsti)THEN
firsti=allresdt
END IF

allresdt=allresdt/firsti


    IF (n.eq.0)THEN
    write(777,*)allresdt,jj,it
    END IF


!$OMP END MASTER
!$OMP BARRIER 

    
  IF ((allresdt.le.inner_tol).or.(jj.eq.upperlimit))THEN
 !$OMP DO SCHEDULE (STATIC)
  DO I=1,KMAXE
 U_C(I)%VAL(1,1:nof_Variables)=U_C(I)%VAL(1,1:nof_Variables)+IMPDU(I,1:nof_Variables)
    IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
    do k=1,turbulenceequations+passivescalar
  U_CT(I)%VAL(1,k)=U_CT(I)%VAL(1,k)+IMPDU(i,nof_Variables+k)
    END do
    END IF
  END DO
!$OMP END DO
  exit

ELSE
 !$OMP DO SCHEDULE (STATIC)
 DO I=1,KMAXE
 U_C(I)%VAL(1,1:nof_Variables)=U_C(I)%VAL(1,1:nof_Variables)+IMPDU(I,1:nof_Variables)
  IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
    do k=1,turbulenceequations+passivescalar
  U_CT(I)%VAL(1,k)=U_CT(I)%VAL(1,k)+IMPDU(i,nof_Variables+k)
    END do
    END IF
  END DO
!$OMP END DO

END IF






END DO






!$OMP DO
DO I=1,KMAXE 
  U_C(I)%VAL(3,1:NOF_VARIABLES)=U_C(I)%VAL(2,1:NOF_VARIABLES)
  U_C(I)%VAL(2,1:nof_variables)=U_C(I)%VAL(1,1:nof_variables)
  U_C(I)%VAL(1,1:nof_variables)=2.0*U_C(I)%VAL(2,1:nof_variables)-U_C(I)%VAL(3,1:nof_variables)
  
  
  IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
  U_CT(I)%VAL(3,:)=U_CT(I)%VAL(2,:)
  U_CT(I)%VAL(2,:)=U_CT(I)%VAL(1,:)
  U_CT(I)%VAL(1,:)=2.0*U_CT(I)%VAL(2,:)-U_CT(I)%VAL(3,:)
  END IF
END DO
!$OMP END DO












IF (AVERAGING.EQ.1)THEN

 CALL AVERAGING_T(N)
 
END IF



END SUBROUTINE DUAL_TIME_EX





SUBROUTINE DUAL_TIME_EX_2D(N)
!> @brief
!> DUAL TIME STEPPING 2D
INTEGER::I,K,KMAXE,jj
INTEGER,INTENT(IN)::N
reaL::verysmall
real::firsti,resmaxi,rsumfacei,suml2ri,dummy3i,inner_tol
verysmall = tolsmall

inner_tol=reslimit

KMAXE=XMPIELRANK(N)


IF (IT.EQ.RESTART)THEN
!$OMP DO
DO I=1,KMAXE 
  U_C(I)%VAL(3,1:NOF_VARIABLES)=U_C(I)%VAL(1,1:NOF_VARIABLES)
  U_C(I)%VAL(2,1:nof_variables)=U_C(I)%VAL(1,1:nof_variables)
  IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
  U_CT(I)%VAL(3,:)=U_CT(I)%VAL(1,:)
  U_CT(I)%VAL(2,:)=U_CT(I)%VAL(1,:)
  END IF
END DO
!$OMP END DO
END IF





firsti=0.0d0
DO JJ=1,upperlimit
      rsumfacei=zero;allresdt=zero;dummy3i=zero; 
      
      
      
      
      
      
IF (FASTEST.EQ.1)THEN
    CALL EXCHANGE_LOWER(N)
    CALL ARBITRARY_ORDER2(N)
    CALL EXHBOUNDHIGHER(N)
    
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI2d(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2d(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2d(N)
    CALL CALCULATE_FLUXESHI_dIFfusive2d(N)
    CALL VORTEXCALC2d(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION2d(N)
    END IF
    END SELECT
    
ELSE
    CALL EXCHANGE_HIGHER(N)
    CALL ARBITRARY_ORDER2(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI2d(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2d(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2d(N)
    CALL CALCULATE_FLUXESHI_dIFfusive2d(N)
    CALL VORTEXCALC2d(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION2d(N)
    END IF
    END SELECT
END IF


CALL RELAXATION_EX(N)





!$OMP BARRIER 
!$OMP DO SCHEDULE(STATIC) REDUCTION(+:allresdt)
DO I=1,KMAXE
      rsumfacei=sqrt(((IMPDU(I,1))**2)+((IMPDU(I,2))**2)+((IMPDU(I,3))**2)+((IMPDU(I,4))**2))
      allresdt=allresdt+(rsumfacei*ielem(n,i)%totvolume)
END do
!$OMP END DO

!$OMP BARRIER 
!$OMP MASTER
DUMMY3I=zero

CALL MPI_ALLREDUCE(allresdt,DUMMY3i,1,MPI_DOUBLE_PRECISION,MPI_SUM,MPI_COMM_WORLD,IERROR)
allresdt=dummy3i/TOTALVOLUME



IF (allresdt.gt.firsti)THEN
firsti=allresdt
END IF

allresdt=allresdt/firsti


    IF (n.eq.0)THEN
    write(777,*)allresdt,jj,it
    END IF


!$OMP END MASTER
!$OMP BARRIER 

    
  IF ((allresdt.le.inner_tol).or.(jj.eq.upperlimit))THEN
 !$OMP DO SCHEDULE (STATIC)
  DO I=1,KMAXE
 U_C(I)%VAL(1,1:nof_Variables)=U_C(I)%VAL(1,1:nof_Variables)+IMPDU(I,1:nof_Variables)
    IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
    do k=1,turbulenceequations+passivescalar
  U_CT(I)%VAL(1,k)=U_CT(I)%VAL(1,k)+IMPDU(i,nof_Variables+k)
    END do
    END IF
  END DO
!$OMP END DO
  exit

ELSE
 !$OMP DO SCHEDULE (STATIC)
 DO I=1,KMAXE
 U_C(I)%VAL(1,1:nof_Variables)=U_C(I)%VAL(1,1:nof_Variables)+IMPDU(I,1:nof_Variables)
  IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
    do k=1,turbulenceequations+passivescalar
  U_CT(I)%VAL(1,k)=U_CT(I)%VAL(1,k)+IMPDU(i,nof_Variables+k)
    END do
    END IF
  END DO
!$OMP END DO

END IF






END DO






!$OMP DO
DO I=1,KMAXE 
  U_C(I)%VAL(3,1:NOF_VARIABLES)=U_C(I)%VAL(2,1:NOF_VARIABLES)
  U_C(I)%VAL(2,1:nof_variables)=U_C(I)%VAL(1,1:nof_variables)
  U_C(I)%VAL(1,1:nof_variables)=2.0*U_C(I)%VAL(2,1:nof_variables)-U_C(I)%VAL(3,1:nof_variables)
  
  
  IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
  U_CT(I)%VAL(3,:)=U_CT(I)%VAL(2,:)
  U_CT(I)%VAL(2,:)=U_CT(I)%VAL(1,:)
  U_CT(I)%VAL(1,:)=2.0*U_CT(I)%VAL(2,:)-U_CT(I)%VAL(3,:)
  END IF
END DO
!$OMP END DO












IF (AVERAGING.EQ.1)THEN

 CALL AVERAGING_T(N)
 
END IF




  
END SUBROUTINE dual_time_ex_2d



















SUBROUTINE DUAL_TIME_2d(N)
!> @brief
!> DUAL TIME STEPPING 2D
IMPLICIT NONE
INTEGER::I,K,KMAXE,jj
INTEGER,INTENT(IN)::N
reaL::verysmall
real::firsti,resmaxi,rsumfacei,suml2ri,dummy3i,inner_tol
verysmall = tolsmall

inner_tol=reslimit

KMAXE=XMPIELRANK(N)

 
IF (IT.EQ.RESTART)THEN
!$OMP DO
DO I=1,KMAXE 
  U_C(I)%VAL(3,1:NOF_VARIABLES)=U_C(I)%VAL(1,1:NOF_VARIABLES)
  U_C(I)%VAL(2,1:nof_variables)=U_C(I)%VAL(1,1:nof_variables)
  
  if ((turbulence.gt.0).or.(passivescalar.gt.0))then
  U_CT(I)%VAL(3,:)=U_CT(I)%VAL(1,:)
  U_CT(I)%VAL(2,:)=U_CT(I)%VAL(1,:)
  
  end if
END DO
!$OMP END DO
END IF



firsti=0.0d0
DO JJ=1,upperlimit
      rsumfacei=zero;allresdt=zero;dummy3i=zero; 
      if (jj.eq.1)then
    iscoun=1
      else
      iscoun=2
      end if
      

      
IF (FASTEST.EQ.1)THEN
    CALL EXCHANGE_LOWER(N)
    CALL ARBITRARY_ORDER2(N)
    CALL EXHBOUNDHIGHER(N)
    
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI2d(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2d(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2d(N)
    CALL CALCULATE_FLUXESHI_dIFfusive2d(N)
    CALL VORTEXCALC2D(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION2d(N)
    END IF
    END SELECT
    
ELSE
    CALL EXCHANGE_HIGHER(N)
    CALL ARBITRARY_ORDER2(N)
    CALL EXHBOUNDHIGHER(N)
    SELECT CASE(ITESTCASE)
    CASE(1,2)
    CALL CALCULATE_FLUXESHI2d(N)
    CASE(3)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2d(N)
    CASE(4)
    CALL CALCULATE_FLUXESHI_CONVECTIVE2d(N)
    CALL CALCULATE_FLUXESHI_dIFfusive2d(N)
    CALL VORTEXCALC2D(N)
    IF (turbulence.eq.1)THEN
    CALL SOURCES_COMPUTATION2d(N)
    END IF
    END SELECT
END IF


IF (relax.eq.3)THEN



CALL RELAXATION_LUMFREE(N)


ELSE



IF (lowmemory.eq.0)THEN
   
 CALL RELAXATION2d(N)
   
 ELSE
 
 CALL RELAXATION_lm2d(N)
 
 END IF
 
END IF

!$OMP BARRIER 
!$OMP DO SCHEDULE(STATIC) REDUCTION(+:allresdt)
DO I=1,KMAXE
      rsumfacei=sqrt(((IMPDU(I,1))**2)+((IMPDU(I,2))**2)+((IMPDU(I,3))**2)+((IMPDU(I,4))**2))
      allresdt=allresdt+(rsumfacei*ielem(n,i)%totvolume)
END do
!$OMP END DO

!$OMP BARRIER 
!$OMP MASTER
DUMMY3I=zero

CALL MPI_ALLREDUCE(allresdt,DUMMY3i,1,MPI_DOUBLE_PRECISION,MPI_SUM,MPI_COMM_WORLD,IERROR)
allresdt=dummy3i/TOTALVOLUME



IF (allresdt.gt.firsti)THEN
firsti=allresdt
END IF

allresdt=allresdt/firsti


IF (n.eq.0)THEN
write(777,*)allresdt,jj,it

END IF


!$OMP END MASTER
!$OMP BARRIER 




  IF ((allresdt.le.inner_tol).or.(jj.eq.upperlimit))THEN
 !$OMP DO SCHEDULE (STATIC)
  DO I=1,KMAXE
 U_C(I)%VAL(1,1:nof_Variables)=U_C(I)%VAL(1,1:nof_Variables)+IMPDU(I,1:nof_Variables)
    IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
    do k=1,turbulenceequations+passivescalar
	IF (U_CT(I)%VAL(1,k)+IMPDU(I,nof_Variables+k).ge.zero)THEN
  U_CT(I)%VAL(1,k)=U_CT(I)%VAL(1,k)+IMPDU(i,nof_Variables+k)
	END IF
    END do
    END IF
  END DO
!$OMP END DO
  exit

ELSE
 !$OMP DO SCHEDULE (STATIC)
 DO I=1,KMAXE
 U_C(I)%VAL(1,1:nof_Variables)=U_C(I)%VAL(1,1:nof_Variables)+IMPDU(I,1:nof_Variables)
    IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
    do k=1,turbulenceequations+passivescalar
	IF (U_CT(I)%VAL(1,k)+IMPDU(I,nof_Variables+k).ge.zero)THEN
  U_CT(I)%VAL(1,k)=U_CT(I)%VAL(1,k)+IMPDU(i,nof_Variables+k)
	END IF
    END do
    END IF
  END DO
!$OMP END DO

END IF


END DO





!$OMP DO
DO I=1,KMAXE 
  U_C(I)%VAL(3,1:NOF_VARIABLES)=U_C(I)%VAL(2,1:NOF_VARIABLES)
  U_C(I)%VAL(2,1:nof_variables)=U_C(I)%VAL(1,1:nof_variables)
  !U_C(I)%VAL(1,1:nof_variables)=(2.0*U_C(I)%VAL(2,1:nof_variables))-U_C(I)%VAL(3,1:nof_variables)
  
  
  IF ((turbulence.gt.0).or.(passivescalar.gt.0))THEN
  U_CT(I)%VAL(3,:)=U_CT(I)%VAL(2,:)
  U_CT(I)%VAL(2,:)=U_CT(I)%VAL(1,:)
  !U_CT(I)%VAL(1,:)=2.0*U_CT(I)%VAL(2,:)-U_CT(I)%VAL(3,:)
  end if
END DO
!$OMP END DO





IF (AVERAGING.EQ.1)THEN

 CALL AVERAGING_T(N)
 
END IF

END SUBROUTINE dual_time_2d




SUBROUTINE RELAXATION_EX(N)
IMPLICIT NONE
!> @brief
!> This subroutine solves the linear system for implicit time stepping either through MATRIX FREE LU-SGS low memory footprint
INTEGER,INTENT(IN)::N
INTEGER::I,L,K,II,SWEEPS,kmaxe,igoflux,icaseb,INDT1,INDT2,INDT3,IJK
real::dt1,dtau



kmaxe=xmpielrank(n)

impdu(:,:)=zero

INDT1=NOF_VARIABLES+1
INDT2=NOF_VARIABLES+TURBULENCEEQUATIONS+PASSIVESCALAR
INDT3=TURBULENCEEQUATIONS+PASSIVESCALAR



!$OMP DO SCHEDULE (STATIC)
DO I=1,KMAXE
dt1=ielem(n,i)%totvolume/dt
IMPDU(I,1:nof_variables)=DT1*(1.5D0*U_C(I)%VAL(1,1:nof_Variables)-2.0D0*U_C(I)%VAL(2,1:nof_Variables)+0.5D0*U_C(I)%VAL(3,1:nof_Variables))+RHS(I)%VAL(1:nof_variables)

IF ((TURBULENCE.GT.0).OR.(PASSIVESCALAR.GT.0))THEN
impdu(I,INDT1:INDT2)=DT1*(1.5D0*U_CT(I)%VAL(1,1:INDT3)-2.0D0*U_CT(I)%VAL(2,1:INDT3)+0.5D0*U_CT(I)%VAL(3,1:INDT3))+RHST(I)%VAL(1:INDT3)
END IF

END DO
!$OMP END DO 


!$OMP DO SCHEDULE (STATIC)
DO I=1,KMAXE
dtau=(ielem(n,i)%dtl/IELEM(N,I)%TOTVOLUME)*(1.0d0/(1.0D0+1.5D0*(ielem(n,i)%dtl/DT)))
IMPDU(I,1:nof_variables)=-IMPDU(I,1:nof_variables)*dtau
IF ((TURBULENCE.GT.0).OR.(PASSIVESCALAR.GT.0))THEN
impdu(I,INDT1:INDT2)=-impdu(I,INDT1:INDT2)*dtau
END IF
END DO
!$OMP END DO 

                                       
END SUBROUTINE RELAXATION_EX





SUBROUTINE AVERAGING_T(N)
!> @brief
!> TEMPORAL AVERAGING FOR UNSTEADY SIMULATIONS
IMPLICIT NONE
INTEGER,INTENT(IN)::N
INTEGER::I,KMAXE,nvar
integer::ind1
KMAXE=XMPIELRANK(N)



IF (DIMENSIONA.EQ.3)THEN
IF (rungekutta.eq.4)THEN
ind1=7
ELSE
ind1=5
END IF

  IF (tz1.gt.zero)THEN
 !$OMP DO
  DO I=1,KMAXE
    U_C(I)%val(ind1,:)=(((Tz1-dt)/(Tz1))*U_C(I)%val(ind1,:))+((dt*U_C(I)%VAL(1,:))/Tz1)
      IF ((TURBULENCE.EQ.1).OR.(PASSIVESCALAR.GT.0))THEN
    DO NVAR=1,TURBULENCEEQUATIONS+PASSIVESCALAR
    
    U_CT(I)%val(ind1,NVAR)=(((Tz1-dt)/(Tz1))*U_CT(I)%val(ind1,NVAR))+((dt*U_CT(I)%VAL(1,NVAR))/(Tz1*U_C(I)%val(ind1,1)))
    
    END DO
    END IF
    !U,V,W,UV,UW,WV,PS
    U_C(I)%RMS(1)=SQRT(abs(((U_C(I)%RMS(1)**2)*((Tz1-dt)/(Tz1)))+(((U_C(I)%VAL(1,2)/U_C(I)%VAL(1,1)-U_C(I)%val(ind1,2)/U_C(I)%val(ind1,1))**2)*dt/Tz1)))
    U_C(I)%RMS(2)=SQRT(abs(((U_C(I)%RMS(2)**2)*((Tz1-dt)/(Tz1)))+(((U_C(I)%VAL(1,3)/U_C(I)%VAL(1,1)-U_C(I)%val(ind1,3)/U_C(I)%val(ind1,1))**2)*dt/Tz1)))
    U_C(I)%RMS(3)=SQRT(abs(((U_C(I)%RMS(3)**2)*((Tz1-dt)/(Tz1)))+(((U_C(I)%VAL(1,4)/U_C(I)%VAL(1,1)-U_C(I)%val(ind1,4)/U_C(I)%val(ind1,1))**2)*dt/Tz1)))
    
    
    
    
   
    U_C(I)%RMS(4)=(((U_C(I)%RMS(4))*((Tz1-DT)/(Tz1)))+&
(((((U_C(I)%VAL(1,2)/U_C(I)%VAL(1,1))-(U_C(I)%val(ind1,2)/U_C(I)%val(ind1,1)))*((U_C(I)%VAL(1,3)/U_C(I)%VAL(1,1))-(U_C(I)%val(ind1,3)/U_C(I)%val(ind1,1)))))*DT/Tz1))
    U_C(I)%RMS(5)=(((U_C(I)%RMS(5))*((Tz1-DT)/(Tz1)))+&
(((((U_C(I)%VAL(1,2)/U_C(I)%VAL(1,1))-(U_C(I)%val(ind1,2)/U_C(I)%val(ind1,1)))*((U_C(I)%VAL(1,4)/U_C(I)%VAL(1,1))-(U_C(I)%val(ind1,4)/U_C(I)%val(ind1,1)))))*DT/Tz1))
    U_C(I)%RMS(6)=(((U_C(I)%RMS(6))*((Tz1-DT)/(Tz1)))+&
(((((U_C(I)%VAL(1,3)/U_C(I)%VAL(1,1))-(U_C(I)%val(ind1,3)/U_C(I)%val(ind1,1)))*((U_C(I)%VAL(1,4)/U_C(I)%VAL(1,1))-(U_C(I)%val(ind1,4)/U_C(I)%val(ind1,1)))))*DT/Tz1))
    IF ((PASSIVESCALAR.GT.0))THEN
    U_C(I)%RMS(7)=SQRT(abs(((U_C(I)%RMS(7)**2)*((Tz1-DT)/(Tz1)))+(((U_CT(I)%VAL(1,TURBULENCEEQUATIONS+1)&
-U_CT(I)%val(ind1,TURBULENCEEQUATIONS+1))**2)*DT/Tz1)))
    END IF
   
   
   
    
  END DO
  !$OMP END DO
  ELSE
  !$OMP DO
  DO I=1,KMAXE
    U_C(I)%val(ind1,:)=ZERO;U_C(I)%RMS=zero
    IF ((TURBULENCE.EQ.1).OR.(PASSIVESCALAR.GT.0))THEN
    
    
    U_CT(I)%val(ind1,:)=ZERO
    
    
    END IF
  
  END DO
  !$OMP END DO
  END IF

ELSE
IF (t.gt.0.0)THEN
  !$OMP DO
  DO I=1,KMAXE
    U_C(I)%val(ind1,:)=(((Tz1-dt)/(Tz1))*U_C(I)%val(ind1,:))+((dt*U_C(I)%VAL(1,:))/Tz1)
      IF ((TURBULENCE.EQ.1).OR.(PASSIVESCALAR.GT.0))THEN
    DO NVAR=1,TURBULENCEEQUATIONS+PASSIVESCALAR
    
    U_CT(I)%val(ind1,NVAR)=(((Tz1-dt)/(Tz1))*U_CT(I)%val(ind1,NVAR))+((dt*U_CT(I)%VAL(1,NVAR))/(Tz1*U_C(I)%val(ind1,1)))
    
    END DO
    END IF
    !U,V,UV,PS
    U_C(I)%RMS(1)=SQRT(abs(((U_C(I)%RMS(1)**2)*((Tz1-dt)/(Tz1)))+(((U_C(I)%VAL(1,2)-U_C(I)%val(ind1,2))**2)*dt/Tz1)))/U_C(I)%val(ind1,1)
    U_C(I)%RMS(2)=SQRT(abs(((U_C(I)%RMS(2)**2)*((Tz1-dt)/(Tz1)))+(((U_C(I)%VAL(1,3)-U_C(I)%val(ind1,3))**2)*dt/Tz1)))/U_C(I)%val(ind1,1)
    
   
    U_C(I)%RMS(3)=(((U_C(I)%RMS(4))*((Tz1-dt)/(Tz1)))+&
((((U_C(I)%VAL(1,2)-U_C(I)%val(ind1,2))*(U_C(I)%VAL(1,3)-U_C(I)%val(ind1,3))))*dt/Tz1))/U_C(I)%val(ind1,1)
    
    IF ((PASSIVESCALAR.GT.0))THEN
    U_C(I)%RMS(4)=SQRT(abs(((U_C(I)%RMS(4)**2)*((Tz1-dt)/(Tz1)))+(((U_CT(I)%VAL(1,TURBULENCEEQUATIONS+1)&
-U_CT(I)%val(ind1,TURBULENCEEQUATIONS+1))**2)*dt/Tz1)))/U_C(I)%val(ind1,1)
    END IF
    
  END DO
  !$OMP END DO
  ELSE
  !$OMP DO
  DO I=1,KMAXE
    U_C(I)%val(ind1,:)=ZERO
    IF ((TURBULENCE.EQ.1).OR.(PASSIVESCALAR.GT.0))THEN
    
    
    U_CT(I)%val(ind1,:)=ZERO
    
    
    END IF
  
  END DO
  !$OMP END DO
  END IF
 END IF


   
   IF (OUTSURF.EQ.1)THEN
   CALL EXCHANGE_HIGHER_AV(N)
   CALL AVERAGE_STRESSES(N)
   END IF
   
END SUBROUTINE AVERAGING_T


! ! !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
! ! !---------------------------------------------------------------------------------------------!
! ! !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
! ! !!!!!!!!!!!!!!!!!!SUBROUTINE CALLED TO ADVANCE SOLUTION BY ONE TIME STEP SIZE!!!!!!!!!!!!!!!!!!
! ! !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
! ! !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
! ! !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

SUBROUTINE TIME_MARCHING(N)
!> @brief
!> TIME MARCHING SUBROUTINE 3D
IMPLICIT NONE
INTEGER,INTENT(IN)::N
real,dimension(1:5)::DUMMYOUT,DUMMYIN
INTEGER::I,KMAXE,TTIME
REAL::CPUT1,CPUT2,CPUT3,CPUT4,CPUT5,CPUT6,CPUT8,timec3,TIMEC1,TIMEC4,TIMEC8,TOTV1,TOTV2,DUMEtg1,DUMEtg2,TOTK
      kill=0
      T=RES_TIME
      iscoun=1
      
      EVERY_TIME=RES_TIME+1.0D0
      

!$OMP BARRIER
!$OMP MASTER 
    IF (INITCOND.eq.95)THEN                    
    CALL CHECKPOINTv3(N)
    end if
	CPUT1=CPUX1(1)
	CPUT4=CPUX1(1)
	CPUT5=CPUX1(1)
	CPUT8=CPUX1(1)
!$OMP END MASTER 
!$OMP BARRIER
      
	      			
	IT=RESTART
      
!$OMP BARRIER
!$OMP MASTER 
      CALL GRID_WRITE
      IF ((Average_restart.eq.0).and.(averaging.eq.1)) THEN
				Tz1=0.0
				ELSE
				tz1=t
		END IF
      
      
!$OMP END MASTER 
!$OMP BARRIER
      


!$OMP BARRIER
!$OMP MASTER
	CALL VOLUME_SOLUTION_WRITE
	IF (OUTSURF.EQ.1)THEN
	CALL SURF_WRITE
	END IF
!$OMP END MASTER
!$OMP BARRIER
      
      
     DO 
		    CALL CALCULATE_CFL(N)
		    
		    IF (RUNGEKUTTA.GE.5)CALL CALCULATE_CFLL(N)
		    
		    !$OMP BARRIER
			!$OMP MASTER
			DUMMYOUT(1)=DT
			CPUT2=MPI_WTIME()
			TIMEC8=CPUT2-CPUT8
			TIMEC1=CPUT2-CPUT1
		        dummyout(2)=TIMEC1
			DUMMYIN=0.0
			timec3=cput2-cput4
			dummyout(3)=TIMEC3
			TIMEC4=CPUT2-CPUT5
			dummyout(4)=TIMEC4
			DUMMYOUT(5)=TIMEC8
			
			CALL MPI_ALLREDUCE(DUMMYOUT,DUMMYIN,5,MPI_DOUBLE_PRECISION,MPI_MIN,MPI_COMM_WORLD,IERROR)
			
			DT=DUMMYIN(1)
			TIMEC1=DUMMYIN(2)
			TIMEC3=DUMMYIN(3)
			TIMEC4=DUMMYIN(4)
			TIMEC8=DUMMYIN(5)
				   IF (N.EQ.0)THEN
				  OPEN(63,FILE='history.txt',FORM='FORMATTED',STATUS='old',ACTION='WRITE',POSITION='APPEND')
				  WRITE(63,*)DT,it,"TIME STEP SIZE",T
				  CLOSE(63)
				  END IF
					
					
					IF (INITCOND.eq.95)THEN                    
 				TOTK=0
 				DO I=1,xmpielrank(n)
					TOTK=TOTK+IELEM(N,I)%TOTVOLUME*U_C(I)%VAL(1,1)*(1.0/2.0)*&
(((U_C(I)%VAL(1,2)/U_C(I)%VAL(1,1))**2)+((U_C(I)%VAL(1,3)/U_C(I)%VAL(1,1))**2)+((U_C(I)%VAL(1,4)/U_C(I)%VAL(1,1))**2))
				END DO
! 				
 				DUMEtg1=TOTK
 				DUMEtg2=0.0
 				CALL MPI_BARRIER(MPI_COMM_WORLD,IERROR)
 				CALL MPI_ALLREDUCE(DUMEtg1,DUMEtg2,1,MPI_DOUBLE_PRECISION,MPI_SUM,MPI_COMM_WORLD,IERROR)
 				TOTK=DUMEtg2
 				IF (N.EQ.0)THEN
 				TOTV1=TOTK/((2.0*PI)**3)
					IF (it.eq.0)THEN
					TAYLOR=TOTK
					END IF
					
				
				
				END IF
 				
 				
!  				CALL MPI_BARRIER(MPI_COMM_WORLD,IERROR)
 				

! 				END IF
			    END IF
			
			
			IF (rungekutta.GE.11)THEN
			dt=timestep
			IF (INITCOND.eq.95)THEN 
			DT=MIN(DT,OUT_TIME-T,EVERY_TIME-T)
			ELSE
			DT=MIN(DT,OUT_TIME-T)
			END IF
			else
			IF (INITCOND.eq.95)THEN 
			DT=MIN(DT,OUT_TIME-T,EVERY_TIME-T)
			ELSE
			DT=MIN(DT,OUT_TIME-T)
			END IF
			end if
			
			!$OMP END MASTER 
			!$OMP BARRIER	
			
			SELECT CASE(RUNGEKUTTA)
			
			CASE(1)
			CALL RUNGE_KUTTA1(N)
			
			CASE(2)
			CALL RUNGE_KUTTA2(N)
			
			CASE(3)
			
			IF (MOOD.EQ.1)THEN
			CALL RUNGE_KUTTA3_MOOD(N)
			ELSE
			CALL RUNGE_KUTTA3(N)
			END IF
			
			CASE(4)
			CALL RUNGE_KUTTA4(N)
			
			CASE(5)
			CALL RUNGE_KUTTA5(N)
			
			case(10)
			CALL IMPLICIT_TIMEs(N)
			
			
			case(11)
			CALL dual_TIME(N)
			
			
			case(12)
			CALL dual_TIME_EX(N)
			
			
			END SELECT
			
			!$OMP BARRIER
			!$OMP MASTER
			
			IF (rungekutta.GE.11)THEN
 			 T=T+(DT)
 			  Tz1=Tz1+(DT)

			ELSE
                       T=T+DT
			tz1=tz1+DT
			  END IF
			  
			
			
! 			IF (N.EQ.0)THEN
! 				  OPEN(63,FILE='history.txt',FORM='FORMATTED',STATUS='old',ACTION='WRITE',POSITION='APPEND')
! 				  IF (rungekutta.eq.11)THEN
! 				  WRITE(63,*)DT,it,"TIME STEP SIZE",T
! 				  END IF
! 				  CLOSE(63)
! 				  END IF
			
			
			IF (INITCOND.eq.95)THEN                    
 				TOTK=0
 				DO I=1,xmpielrank(n)
					TOTK=TOTK+IELEM(N,I)%TOTVOLUME*U_C(I)%VAL(1,1)*(1.0/2.0)*&
(((U_C(I)%VAL(1,2)/U_C(I)%VAL(1,1))**2)+((U_C(I)%VAL(1,3)/U_C(I)%VAL(1,1))**2)+((U_C(I)%VAL(1,4)/U_C(I)%VAL(1,1))**2))
				END DO
! 				
 				DUMEtg1=TOTK
 				DUMEtg2=0.0
 				CALL MPI_BARRIER(MPI_COMM_WORLD,IERROR)
 				CALL MPI_ALLREDUCE(DUMEtg1,DUMEtg2,1,MPI_DOUBLE_PRECISION,MPI_SUM,MPI_COMM_WORLD,IERROR)
 				TOTK=DUMEtg2
 				IF (N.EQ.0)THEN
 				TOTV2=TOTK/((2.0*PI)**3)
					IF (it.eq.0)THEN
					TAYLOR=TOTK
					END IF
					
				IF (IT.EQ.0)THEN
				OPEN(73,FILE='ENERGY.dat',FORM='FORMATTED',STATUS='NEW',ACTION='WRITE',POSITION='APPEND')
				ELSE
				OPEN(73,FILE='ENERGY.dat',FORM='FORMATTED',STATUS='old',ACTION='WRITE',POSITION='APPEND')
				END IF
				WRITE(73,*)T,TOTK/TAYLOR,-(TOTV2-TOTV1)/DT
				CLOSE(73)
				END IF
 				
 				
 				CALL MPI_BARRIER(MPI_COMM_WORLD,IERROR)
 				

! 				END IF
			    END IF
           
			    IF((initcond.eq.408).or.(initcond.eq.422))THEN
			    IF ( mod(it, 40) .eq. 0)THEN
                    CALL TRAJECTORIES
			    END IF
			    END IF
			
			
			
			!$OMP END MASTER 
			!$OMP BARRIER
			
			IF ( mod(it, IForce) .eq. 0) THEN
			IF (OUTSURF.EQ.1) THEN   
				  CALL forces
			END IF
			END IF
			
			IF ((rungekutta.ge.5).and.(rungekutta.lt.11))THEN
			IF ( mod(it, residualfreq) .eq. 0) THEN
                               CALL RESIDUAL_COMPUTE
			END IF
			END IF
			
			!$OMP MASTER
			IF (NPROBES.GT.0) CALL PROBING
					
			
			IF (TIMEC1.GE.IEVERY)THEN
			    CALL VOLUME_SOLUTION_WRITE
			     IF (outsurf.eq.1)THEN
			    CALL surface_SOLUTION_WRITE
			    END IF
			CPUT1=MPI_WTIME()
			END IF
			
			IF (INITCOND.eq.95)THEN           
			if (mod(T, 1.0D0) .eq. 0) then
                CALL VOLUME_SOLUTION_WRITE
			     if (outsurf.eq.1)then
			    call surface_SOLUTION_WRITE
			    end if
			    IF (INITCOND.eq.95)THEN                    
			    CALL CHECKPOINTv4(N)
			    END IF
			EVERY_TIME=EVERY_TIME+1.0D0
            
           
           END IF
           END IF
			
			
			
			
			IF (TIMEC8.GE.IEVERYAV)THEN
			IF (AVERAGING.EQ.1)THEN
			CALL VOLUME_SOLUTION_WRITE_av
			   IF (outsurf.eq.1)THEN
			  CALL surface_SOLUTION_WRITE_av
			  END IF
			END IF
			CPUT8=MPI_WTIME()
			END IF
			
			
			
			IF (TIMEC4.GE.IEVERY2)THEN
			    CALL CHECKPOINTING
			      IF (AVERAGING.EQ.1)THEN
				CALL CHECKPOINTING_av
			      END IF
	
			  CPUT5=MPI_WTIME()
			  
			END IF
			  
			
			!$OMP END MASTER 
			!$OMP BARRIER
			
			
			
			!$OMP MASTER
			IT=IT+1
			
			IF ((IT.EQ.NTMAX).OR.(TIMEC3.GE.WALLC))THEN
			 KILL=1
			END IF
			
			IF ((rungekutta.lt.5).or.(rungekutta.GE.11))THEN
			IF (T.GE.OUT_TIME)THEN
			KILL=1
			END IF
			END IF
			!$OMP END MASTER 
			!$OMP BARRIER

			  
			!$OMP MASTER
			IF (kill.eq.1)THEN
			    CALL VOLUME_SOLUTION_WRITE
			      IF (outsurf.eq.1)THEN
			      CALL surface_SOLUTION_WRITE
			      END IF
			    CALL CHECKPOINTING
			      IF (AVERAGING.EQ.1)THEN
			      CALL VOLUME_SOLUTION_WRITE_av
				IF (outsurf.eq.1)THEN
				  CALL surface_SOLUTION_WRITE_av
				END IF	    
				CALL CHECKPOINTING_av
			      END IF
			END IF
			
			!$OMP END MASTER
			!$OMP BARRIER
			
			IF (kill.eq.1)THEN
			IF (itestcase.le.3)THEN   
			CALL CALCULATE_ERROR(n)
			END IF			  
			  
			return
			END IF
END do
		      
END SUBROUTINE TIME_MARCHING



SUBROUTINE TIME_MARCHING2(N)
!> @brief
!> TIME MARCHING SUBROUTINE 2D
IMPLICIT NONE
INTEGER,INTENT(IN)::N
real,dimension(1:5)::DUMMYOUT,DUMMYIN
INTEGER::I,KMAXE
REAL::CPUT1,CPUT2,CPUT3,CPUT4,CPUT5,CPUT6,CPUT8,timec3,TIMEC1,TIMEC4,TIMEC8,TOTV1,TOTV2,DUMEtg1,DUMEtg2,TOTK

kmaxe=XMPIELRANK(n)
kill=0
T=res_time
iscoun=1
!$OMP MASTER 
CPUT1=CPUX1(1)
CPUT4=CPUX1(1)
CPUT5=CPUX1(1)
CPUT8=CPUX1(1)
!$OMP END MASTER 
!$OMP BARRIER

IT=RESTART

!$OMP MASTER 
CALL GRID_WRITE
CALL VOLUME_SOLUTION_WRITE
IF (outsurf.eq.1)THEN
    CALL SURF_WRITE
END IF

IF ((Average_restart.eq.0).and.(averaging.eq.1)) THEN
    Tz1=0.0
ELSE
    tz1=t
END IF
!$OMP END MASTER 
!$OMP BARRIER
      
DO
    CALL CALCULATE_CFL2D(N)
    IF (RUNGEKUTTA.GE.5) CALL CALCULATE_CFLL2d(N)
        
    !$OMP MASTER
    DUMMYOUT(1)=DT
    CPUT2=MPI_WTIME()
    TIMEC8=CPUT2-CPUT8
    TIMEC1=CPUT2-CPUT1
    DUMMYOUT(2)=TIMEC1
    DUMMYIN=0.0d0
    TIMEC3=CPUT2-CPUT4
    DUMMYOUT(3)=TIMEC3
    TIMEC4=CPUT2-CPUT5
    DUMMYOUT(4)=TIMEC4
    DUMMYOUT(5)=TIMEC8
    
    CALL MPI_ALLREDUCE(DUMMYOUT,DUMMYIN,5,MPI_DOUBLE_PRECISION,MPI_MIN,MPI_COMM_WORLD,IERROR)
    
    DT=DUMMYIN(1)
    TIMEC1=DUMMYIN(2)
    TIMEC3=DUMMYIN(3)
    TIMEC4=DUMMYIN(4)
    TIMEC8=DUMMYIN(5)
    IF (N.EQ.0)THEN
        OPEN(63,FILE='history.txt',FORM='FORMATTED',STATUS='old',ACTION='WRITE',POSITION='APPEND')
        WRITE(63,*)DT,it,"TIME STEP SIZE",T
        CLOSE(63)
    END IF
            
    IF (INITCOND.eq.95)THEN                    
        TOTK=0
        DO I=1,KMAXE
            TOTK=TOTK+IELEM(N,I)%TOTVOLUME*(1.0/2.0)*&
                (((U_C(I)%VAL(1,2)/U_C(I)%VAL(1,1))**2)+((U_C(I)%VAL(1,3)/U_C(I)%VAL(1,1))**2))
        END DO
! 				
        DUMEtg1=TOTK
        DUMEtg2=0.0
        CALL MPI_BARRIER(MPI_COMM_WORLD,IERROR)
        CALL MPI_ALLREDUCE(DUMEtg1,DUMEtg2,1,MPI_DOUBLE_PRECISION,MPI_SUM,MPI_COMM_WORLD,IERROR)
        TOTK=DUMEtg2
        IF (N.EQ.0)THEN
!  				TOTV2=TOTK/((2.0*PI)**3)
! 					IF (it.eq.0)THEN
! 					TAYLOR=TOTK
! 					END IF
            IF (IT.EQ.0)THEN
                OPEN(73,FILE='ENERGY.dat',FORM='FORMATTED',STATUS='NEW',ACTION='WRITE',POSITION='APPEND')
            ELSE
                OPEN(73,FILE='ENERGY.dat',FORM='FORMATTED',STATUS='old',ACTION='WRITE',POSITION='APPEND')
            END IF
            WRITE(73,*)T,TOTK
            CLOSE(73)
        END IF
            
        CALL MPI_BARRIER(MPI_COMM_WORLD,IERROR)
    END IF
    
    IF ((MULTISPECIES.EQ.1))THEN
        IF((initcond.eq.405).or.(initcond.eq.411))THEN
            IF ( mod(it, 20) .eq. 0)THEN
                CALL TRAJECTORIES
            END IF
        END IF
    END IF
        
    IF (rungekutta.GE.11)THEN
        dt=timestep
        DT=MIN(DT,OUT_TIME-T)
    ELSE
        DT=MIN(DT,OUT_TIME-T)
    END IF
            
    !$OMP END MASTER 
    !$OMP BARRIER

    SELECT CASE(RUNGEKUTTA)
    
        CASE(1)
            CALL RUNGE_KUTTA1_2d(N)
        
        CASE(2)
            CALL RUNGE_KUTTA2_2d(N)
        
        CASE(3)
            IF (MOOD.EQ.1)THEN
                CALL RUNGE_KUTTA3_2D_MOOD(N)
            ELSE
                CALL RUNGE_KUTTA3_2D(N)
            END IF
        
        CASE(4)
            CALL RUNGE_KUTTA4_2D(N)
        
        CASE(5)
            CALL RUNGE_KUTTA5_2D(N)
        
        CASE(10)
            CALL IMPLICIT_TIMEs_2d(N)
        
        CASE(11)
            CALL dual_TIME_2d(N)
        
        CASE(12)
            CALL dual_TIME_EX_2D(N)

    END SELECT
        
! Increment time

    !$OMP MASTER
    IF (rungekutta.GE.11)THEN
        T=T+(DT)
        Tz1=Tz1+(DT)
    ELSE
        T=T+DT
        tz1=tz1+DT
    END IF

    
! Write output

    !$OMP END MASTER 
    !$OMP BARRIER
    IF ( mod(it, IForce) .eq. 0) THEN
        IF (OUTSURF.EQ.1) THEN   
            CALL forces
        END IF
    END IF
    
    IF ((rungekutta.ge.5).and.(rungekutta.lt.11))THEN
        IF ( mod(it, residualfreq) .eq. 0) THEN
            CALL RESIDUAL_COMPUTE
        END IF
    END IF
    
    
    !$OMP MASTER
    IF (NPROBES.GT.0) CALL PROBING2D      

    IF (TIMEC1.GE.IEVERY)THEN
        CALL VOLUME_SOLUTION_WRITE
        IF (outsurf.eq.1)THEN
            CALL surface_SOLUTION_WRITE
        END IF
    CPUT1=MPI_WTIME()
    END IF

    
    IF (TIMEC8.GE.IEVERYAV)THEN
        IF (AVERAGING.EQ.1)THEN
            CALL VOLUME_SOLUTION_WRITE_av
            IF (outsurf.eq.1)THEN
                CALL surface_SOLUTION_WRITE_av
            END IF
        END IF
        CPUT8=MPI_WTIME()
    END IF

! Check end condition
    IF ((TIMEC4.GE.IEVERY2).OR.(TIMEC3.GE.WALLC)) THEN
        CPUT5=MPI_WTIME()
        IF (TIMEC3.GE.WALLC) THEN
            KILL=1
        END IF
        
        IF (kill.eq.1)THEN
            CALL VOLUME_SOLUTION_WRITE
            IF (outsurf.eq.1)THEN
                CALL surface_SOLUTION_WRITE
            END IF
            CALL CHECKPOINTING
        
            IF (AVERAGING.EQ.1)THEN
                CALL CHECKPOINTING_av
            END IF
        ELSE
            CALL VOLUME_SOLUTION_WRITE
            IF (outsurf.eq.1)THEN
                CALL surface_SOLUTION_WRITE
            END IF
            IF (AVERAGING.EQ.1)THEN
                CALL CHECKPOINTING_av
            END IF
        END IF
        
    END IF
    IF ((rungekutta.lt.5).or.(rungekutta.GE.11))THEN
        IF (T.GE.OUT_TIME)THEN
            KILL=1
            
            CALL VOLUME_SOLUTION_WRITE
            IF (outsurf.eq.1)THEN
                CALL surface_SOLUTION_WRITE
            END IF
            
            CALL CHECKPOINTING
            
            IF (averaging .eq.1) THEN
                CALL VOLUME_SOLUTION_WRITE_av
                IF (outsurf.eq.1)THEN
                    CALL surface_SOLUTION_WRITE_av
                END IF
                CALL CHECKPOINTING_av
            END IF			
        END IF
    END IF
    !$OMP END MASTER 
    !$OMP BARRIER
    
    
    WRITE(500+N,*) 'IT:',IT
    !$OMP MASTER
    IT=IT+1
    IF (IT.EQ.NTMAX)THEN
        KILL=1
    END IF
    !$OMP END MASTER 
    !$OMP BARRIER
    
    IF (kill.eq.1)THEN ! END DO LOOP
        IF (OUTSURF.EQ.1) THEN   
            CALL forces
        END IF
    
        !$OMP MASTER
        IF ((rungekutta.eq.5).or.(rungekutta.eq.10))THEN
            CALL VOLUME_SOLUTION_WRITE
            IF (outsurf.eq.1)THEN
                CALL surface_SOLUTION_WRITE
            END IF
            
            CALL CHECKPOINTING
        END IF
        !$OMP END MASTER
        !$OMP BARRIER
        
        IF (itestcase.le.3)THEN   
            CALL CALCULATE_ERROR(n)
        END IF
    
    return
    END IF
END DO
		      
END SUBROUTINE TIME_MARCHING2





!---------------------------------------------------------------------------------------------!
END MODULE ADVANCE
